<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Cuaca Interaktif</title>
    
    <link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
    <script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>
    
    <link rel="stylesheet" href="static/styles.css">
    <style>
        /* Tambahkan style sederhana untuk popup daftar klaster */
        .cluster-popup-content { max-height: 240px; overflow-y: auto; font-family: sans-serif; font-size: 13px; }
        .cluster-item { padding: 4px; cursor: pointer; }
        .cluster-item:hover { background-color: #f0f0f0; }
        .maplibregl-popup-content { font-family: sans-serif; font-size: 14px; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="koordinat-info"></div>

    <script>
        const protocol = window.location.protocol;
        const hostname = window.location.hostname;
        const port = '5000';
        const baseUrl = `${protocol}//${hostname}:${port}`;

        document.addEventListener('DOMContentLoaded', function() {
            const map = new maplibregl.Map({
                container: 'map',
                style: {
                    version: 8,
                    glyphs: "https://protomaps.github.io/basemaps-assets/fonts/{fontstack}/{range}.pbf",
                    sources: {
                        'cartodb-positron-nolabels': {
                            type: 'raster',
                            tiles: ['https://basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png'],
                            tileSize: 256,
                            attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
                        },
                        'batas-wilayah-vector': {
                            type: 'vector',
                            tiles: [`${baseUrl}/tiles/{z}/{x}/{y}.pbf`],
                            minzoom: 5,
                            maxzoom: 14
                        },
                        'data-cuaca-source': {
                            type: 'geojson',
                            data: { type: 'FeatureCollection', features: [] },
                            cluster: true,
                            clusterMaxZoom: 13,
                            clusterRadius: 80
                        },
                        'provinsi-source': {
                            type: 'geojson',
                            data: { type: 'FeatureCollection', features: [] }
                        }
                    },
                    layers: [
                        { id: 'cartodb-positron-layer', type: 'raster', source: 'cartodb-positron-nolabels' },
                        { id: 'batas-provinsi-layer', type: 'line', source: 'batas-wilayah-vector', 'source-layer': 'batas_provinsi', minzoom: 5, maxzoom: 7.99, paint: { 'line-color': '#8B4513', 'line-width': 1.5 }},
                        { id: 'batas-kabupaten-layer', type: 'line', source: 'batas-wilayah-vector', 'source-layer': 'batas_kabupatenkota', minzoom: 8, maxzoom: 10.99, paint: { 'line-color': '#003366', 'line-width': 1 }},
                        { id: 'batas-kecamatan-layer', type: 'line', source: 'batas-wilayah-vector', 'source-layer': 'batas_kecamatandistrik', minzoom: 11, maxzoom: 14, paint: { 'line-color': '#276600', 'line-width': 0.8 }},

                        { id: 'provinsi-point-circle', type: 'circle', source: 'provinsi-source',
                          paint: { 'circle-radius': 8, 'circle-color': 'rgba(255, 255, 255, 0.5)', 'circle-stroke-color': '#000000', 'circle-stroke-width': 1.5 }},
                        { id: 'provinsi-point-label', type: 'symbol', source: 'provinsi-source',
                          layout: { 'text-field': ['get', 'nama'], 'text-font': ['Noto Sans Regular'], 'text-size': 11, 'text-anchor': 'left', 'text-offset': [1, 0] },
                          paint: { 'text-color': '#333', 'text-halo-color': '#fff', 'text-halo-width': 1.5, 'text-halo-blur': 1 }},

                        { id: 'cluster-background-layer', type: 'circle', source: 'data-cuaca-source', filter: ['has', 'point_count'],
                          paint: { 'circle-radius': ['step', ['get', 'point_count'], 15, 10, 20, 30, 25],
                                   'circle-color': ['step', ['get', 'point_count'], '#51bbd6', 10, '#f1f075', 30, '#f28cb1'],
                                   'circle-stroke-width': 2, 'circle-stroke-color': '#ffffff' }},
                        { id: 'cluster-count-layer', type: 'symbol', source: 'data-cuaca-source', filter: ['has', 'point_count'],
                          layout: { 'text-field': '{point_count_abbreviated}', 'text-font': ['Noto Sans Regular'], 'text-size': 12 }},

                        { id: 'unclustered-point-layer', type: 'circle', source: 'data-cuaca-source', filter: ['!', ['has', 'point_count']],
                          paint: {
                              // Jika suhu belum ada, tampilkan abu-abu. Jika ada, gunakan palet suhu.
                              'circle-color': [
                                  'case',
                                  ['has', 'suhu'],
                                  ['step', ['get', 'suhu'],
                                      '#fde725', 28, '#f57f20', 30, '#d43f3a'
                                  ],
                                  '#9e9e9e'
                              ],
                              'circle-radius': 6,
                              'circle-stroke-width': 1,
                              'circle-stroke-color': '#fff'
                          }},
                        { id: 'unclustered-point-label', type: 'symbol', source: 'data-cuaca-source', filter: ['!', ['has', 'point_count']],
                          layout: { 'text-field': ['get', 'nama'], 'text-font': ['Noto Sans Regular'], 'text-size': 10, 'text-anchor': 'top', 'text-offset': [0, 0.8] },
                          paint: { 'text-color': '#333', 'text-halo-color': '#fff', 'text-halo-width': 1 }}
                    ]
                },
                center: [118.0149, -2.5489], zoom: 4.5, minZoom: 5, maxZoom: 14,
                maxBounds: [[94.7, -11.3], [141.3, 6.3]]
            });

            map.on('load', () => {
                map.addSource('cartodb-labels', { type: 'raster', tiles: ['https://basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png'], tileSize: 256 });
                map.addLayer({ id: 'cartodb-labels-layer', type: 'raster', source: 'cartodb-labels' });

                map.addControl(new maplibregl.NavigationControl(), 'bottom-right');

                const debounce = (func, delay) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; };

                // ====== State & helper untuk kontrol data ======
                const cuacaSource = () => map.getSource('data-cuaca-source');
                const provinsiSource = () => map.getSource('provinsi-source');

                // Cache cuaca di sisi klien: id -> {suhu, cuaca, kelembapan, terasa}
                const clientWeatherCache = new Map();
                // FeatureCollection aktif saat ini
                let currentFeatureCollection = { type: 'FeatureCollection', features: [] };
                // Untuk hindari request ganda yang sama
                const inflightIds = new Set();

                function setSourceDataFromState() {
                    const src = cuacaSource();
                    if (src) src.setData(currentFeatureCollection);
                }

                function buildFeaturesFromGeoOnly(geoList) {
                    // geoList adalah array dari backend only_geo: [{id, nama, lat, lon}, ...]
                    const features = geoList.map(g => {
                        const cached = clientWeatherCache.get(g.id);
                        const baseProps = { id: g.id, tipe: 'cuaca', nama: g.nama || 'N/A' };
                        const weatherProps = cached ? {
                            suhu: parseFloat((cached.suhu || 0).toFixed(1)),
                            cuaca: cached.cuaca || 'N/A',
                            kelembapan: cached.kelembapan || 0,
                            terasa: parseFloat((cached.terasa || 0).toFixed(1))
                        } : {};
                        return {
                            type: 'Feature',
                            id: g.id, // penting untuk cluster leaves id
                            geometry: { type: 'Point', coordinates: [g.lon, g.lat] },
                            properties: { ...baseProps, ...weatherProps }
                        };
                    });
                    return features;
                }

                function mergeWeatherIntoState(dataMap) {
                    // dataMap berbentuk { id: {id, nama, lat, lon, suhu, cuaca, kelembapan, terasa}, ... }
                    const byId = new Map(currentFeatureCollection.features.map(f => [f.id, f]));
                    for (const id in dataMap) {
                        const d = dataMap[id];
                        // simpan di cache klien
                        clientWeatherCache.set(id, {
                            suhu: d.suhu, cuaca: d.cuaca, kelembapan: d.kelembapan, terasa: d.terasa
                        });
                        // update feature jika ada di koleksi saat ini
                        if (byId.has(id)) {
                            const feat = byId.get(id);
                            feat.properties.suhu = parseFloat((d.suhu || 0).toFixed(1));
                            feat.properties.cuaca = d.cuaca || 'N/A';
                            feat.properties.kelembapan = d.kelembapan || 0;
                            feat.properties.terasa = parseFloat((d.terasa || 0).toFixed(1));
                        }
                    }
                    setSourceDataFromState();
                }

                function getUnclusteredIdsNeedingWeather() {
                    const rendered = map.queryRenderedFeatures({ layers: ['unclustered-point-layer'] }) || [];
                    const ids = [];
                    for (const f of rendered) {
                        // console.log('Processing feature: ', f); // Logging fitur yang diproses
                        const fid = /*f.id ??*/ f.properties?.id;  // Pastikan memperoleh ID dari property yang tepat
                        if (!fid) continue; // Lanjut jika ID tidak ada
                        // console.log('ID Retrieved: ', fid); // Logging ID yang diekstraksi

                        const hasSuhu = typeof f.properties?.suhu !== 'undefined';
                        if (!hasSuhu && !inflightIds.has(fid)) {
                            ids.push(fid); // Tambahkan hanya jika suhu belum ada
                        }
                    }
                    return Array.from(new Set(ids)); // Hapus duplikat dengan Set
                }


                async function fetchWeatherForIds(ids) {
                    if (!ids || ids.length === 0) return;
                    ids.forEach(id => inflightIds.add(id));
                    // console.log('Fetched IDs:', ids); // Debugging di sisi frontend

                    try {
                        const resp = await fetch(`${baseUrl}/api/data-by-ids?ids=${ids.join(',')}`);
                        if (!resp.ok) throw new Error('Respons jaringan tidak baik');
                        const data = await resp.json();
                        mergeWeatherIntoState(data);
                    } catch (e) {
                        console.error('Gagal mengambil data cuaca untuk IDs:', ids, e);
                    } finally {
                        ids.forEach(id => inflightIds.delete(id));
                    }
                }


                function scheduleFetchForUnclustered() {
                    // Jalankan setelah rendering idle agar status cluster sudah final
                    map.once('idle', () => {
                        const ids = getUnclusteredIdsNeedingWeather();
                        if (ids.length) {
                            // Bisa di-batch jika diperlukan, di sini langsung sekali panggil
                            fetchWeatherForIds(ids);
                        }
                    });
                }

                let dataController;
                async function perbaruiPeta() {
                    if (dataController) dataController.abort();
                    dataController = new AbortController();
                    const signal = dataController.signal;
                    const zoom = map.getZoom();

                    if (zoom <= 7.99) {
                        // Tampilkan provinsi, kosongkan marker cuaca
                        cuacaSource().setData({ type: 'FeatureCollection', features: [] });
                        fetch(`${baseUrl}/api/provinsi-info`, { signal })
                            .then(response => response.json())
                            .then(provinsiData => {
                                const features = provinsiData.map(p => ({
                                    type: 'Feature',
                                    geometry: { type: 'Point', coordinates: [p.lon, p.lat] },
                                    properties: { id: p.id, nama: p.nama }
                                }));
                                provinsiSource().setData({ type: 'FeatureCollection', features: features });
                            })
                            .catch(e => { if (e.name !== 'AbortError') console.error('Gagal ambil data provinsi:', e); });
                    } else {
                        // Kosongkan provinsi, tampilkan marker (geo only), cuaca hanya untuk unclustered
                        provinsiSource().setData({ type: 'FeatureCollection', features: [] });

                        const bounds = map.getBounds();
                        const bbox = `${bounds.getWest()},${bounds.getSouth()},${bounds.getEast()},${bounds.getNorth()}`;

                        // Ambil data GEO SAJA (tanpa cuaca)
                        try {
                            const resp = await fetch(`${baseUrl}/api/data-cuaca?bbox=${bbox}&zoom=${zoom}&only_geo=1`, { signal });
                            const geoOnly = await resp.json();
                            if (!geoOnly || geoOnly.error) {
                                console.error("API Error (geo only):", geoOnly);
                                return;
                            }
                            // Bangun features, sisipkan cuaca dari cache klien bila sudah ada
                            currentFeatureCollection = { type: 'FeatureCollection', features: buildFeaturesFromGeoOnly(geoOnly) };
                            setSourceDataFromState();

                            // Setelah data terpasang dan cluster selesai dihitung, ambil cuaca untuk yang unclustered saja
                            scheduleFetchForUnclustered();
                        } catch (e) {
                            if (e.name !== 'AbortError') console.error('Gagal ambil geo only data:', e);
                        }
                    }
                }

                const perbaruiPetaDebounced = debounce(perbaruiPeta, 700);
                map.on('moveend', perbaruiPetaDebounced);
                perbaruiPeta();

                // Popup handling
                let currentPopup = null;
                const closeCurrentPopup = () => { if (currentPopup) { currentPopup.remove(); currentPopup = null; } };

                const allInteractiveLayers = [
                    'cluster-background-layer', 'cluster-count-layer',
                    'unclustered-point-layer', 'provinsi-point-circle'
                ];

                map.on('click', (e) => {
                    const features = map.queryRenderedFeatures(e.point, { layers: allInteractiveLayers });
                    if (!features.length) {
                        closeCurrentPopup();
                        return;
                    }

                    closeCurrentPopup();
                    const feature = features[0];
                    const layerId = feature.layer.id;
                    const props = feature.properties;

                    // Klik klaster: ambil daun (leaves) dan panggil API by IDs saat itu juga
                    if (layerId === 'cluster-background-layer' || layerId === 'cluster-count-layer') {
                        const clusterId = props.cluster_id;
                        const source = cuacaSource();

                        source.getClusterLeaves(clusterId, Infinity, 0, (err, leaves) => {
                            if (err) {
                                console.error("Gagal mendapatkan leaves dari klaster:", err);
                                return;
                            }

                            // Popup "Memuat data..."
                            const loadingPopupHTML = 'Memuat data...';
                            closeCurrentPopup();
                            currentPopup = new maplibregl.Popup({ maxWidth: '260px' })
                                .setLngLat(feature.geometry.coordinates)
                                .setHTML(loadingPopupHTML)
                                .addTo(map);

                            // Ambil semua ID dari marker di dalam klaster
                            const idsToFetch = leaves.map(leaf => /*leaf.id ??*/ leaf.properties?.id).filter(Boolean);

                            fetch(`${baseUrl}/api/data-by-ids?ids=${idsToFetch.join(',')}`)
                                .then(response => {
                                    if (!response.ok) throw new Error('Respons jaringan tidak baik');
                                    return response.json();
                                })
                                .then(dataDetailCuaca => {
                                    // Update cache klien + update feature pada peta
                                    mergeWeatherIntoState(dataDetailCuaca);

                                    // Bangun konten final popup
                                    const popupContent = document.createElement('div');
                                    popupContent.className = 'cluster-popup-content';
                                    popupContent.innerHTML = `<b>${leaves.length} Lokasi:</b><hr style="margin: 4px 0;">`;

                                    // Gunakan data terbaru
                                    for (const id in dataDetailCuaca) {
                                        const data = dataDetailCuaca[id];
                                        const item = document.createElement('div');
                                        item.className = 'cluster-item';
                                        item.innerText = data.nama || 'Nama Tidak Tersedia';

                                        item.onclick = () => {
                                            closeCurrentPopup();
                                            const detailPopupHTML = `
                                                <div>
                                                    <b>${data.nama}</b><br>
                                                    Suhu: ${data.suhu.toFixed(1)}째C<br>
                                                    Cuaca: ${data.cuaca}<br>
                                                    Kelembapan: ${data.kelembapan}%<br>
                                                    Terasa Seperti: ${data.terasa.toFixed(1)}째C<br>
                                                    <button id="center-map-btn" style="margin-top: 8px; cursor: pointer;">Pusatkan Peta</button>
                                                </div>
                                            `;
                                            currentPopup = new maplibregl.Popup()
                                                .setLngLat([data.lon, data.lat])
                                                .setHTML(detailPopupHTML)
                                                .addTo(map);

                                            document.getElementById('center-map-btn').addEventListener('click', () => {
                                                map.easeTo({ center: [data.lon, data.lat], zoom: 12 });
                                            });
                                        };
                                        popupContent.appendChild(item);
                                    }

                                    if (currentPopup) currentPopup.setDOMContent(popupContent);
                                })
                                .catch(error => {
                                    console.error('Gagal mengambil data detail klaster:', error);
                                    if (currentPopup) currentPopup.setHTML('Gagal memuat data.');
                                });
                        });
                        return;
                    }

                    // Klik marker unclustered
                    if (layerId === 'unclustered-point-layer') {
                        const coordinates = feature.geometry.coordinates;
                        const suhu = typeof props.suhu !== 'undefined' ? props.suhu : '...';
                        const cuaca = props.cuaca || '...';
                        const kelembapan = typeof props.kelembapan !== 'undefined' ? props.kelembapan : '...';
                        const terasa = typeof props.terasa !== 'undefined' ? props.terasa : '...';

                        const popupHTML = `<b>${props.nama}</b><br>
                            Suhu: ${suhu}째C<br>
                            Cuaca: ${cuaca}<br>
                            Kelembapan: ${kelembapan}%<br>
                            Terasa Seperti: ${terasa}째C<br>
                            <button id="center-map-btn" style="margin-top: 8px; cursor: pointer;">Pusatkan Peta</button>`;
                        currentPopup = new maplibregl.Popup().setLngLat(feature.geometry.coordinates).setHTML(popupHTML).addTo(map);
                        document.getElementById('center-map-btn').addEventListener('click', () => {
                            map.easeTo({ center: coordinates, zoom: 12 });
                        });

                        // Jika belum punya cuaca (abu-abu), coba muat cuacanya untuk marker ini saja
                        if (typeof props.suhu === 'undefined') {
                            const id = /*feature.id ??*/ props.id;
                            if (id && !inflightIds.has(id)) {
                                fetchWeatherForIds([id]);
                            }
                        }
                        return;
                    }

                    // Klik marker provinsi
                    if (layerId === 'provinsi-point-circle') {
                        const coordinates = feature.geometry.coordinates;
                        const popupHTML = `<b>Provinsi:</b><br>${props.nama}<br>
                            <button id="center-map-btn" style="margin-top: 8px; cursor: pointer;">Pusatkan Peta</button>`;
                        currentPopup = new maplibregl.Popup()
                            .setLngLat(feature.geometry.coordinates)
                            .setHTML(popupHTML)
                            .addTo(map);
                        document.getElementById('center-map-btn').addEventListener('click', () => {
                            map.easeTo({ center: coordinates, zoom: 12 });
                        });
                        return;
                    }
                });

                // Hover pointer
                map.on('mousemove', (e) => {
                    const features = map.queryRenderedFeatures(e.point, { layers: allInteractiveLayers });
                    map.getCanvas().style.cursor = features.length ? 'pointer' : '';
                });

                // Info koordinat
                const infoKoordinat = document.getElementById('koordinat-info');
                infoKoordinat.innerHTML = 'Geser kursor di atas peta';
                map.on('mousemove', (e) => { infoKoordinat.innerHTML = `Latitude: ${e.lngLat.lat.toFixed(5)} | Longitude: ${e.lngLat.lng.toFixed(5)}`; });
                map.on('mouseout', () => { infoKoordinat.innerHTML = 'Geser kursor di atas peta'; });

                // Ketika map selesai render setelah panning/zooming (selain moveend), coba lagi muat untuk unclustered
                // Misal cluster berubah karena zoom, sehingga ada marker baru yang jadi unclustered
                map.on('idle', () => {
                    const zoom = map.getZoom();
                    if (zoom > 7.99) scheduleFetchForUnclustered();
                });
            });
        });
    </script>
</body>
</html>
