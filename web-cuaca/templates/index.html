<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Peta Cuaca dan Gempa Interaktif</title>

  <!-- Leaflet CSS dan JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

  <!-- Untuk marker clustering -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

  <!-- Untuk style peta -->
  <script src="https://unpkg.com/leaflet-providers@1.13.0/leaflet-providers.js"></script>
  <!-- Untuk vector tile -->
  <script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>

  <link rel="stylesheet" href="static/styles.css">
</head>
<body>
  <div id="map"></div>
  <div id="koordinat-info"></div>
  <!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Peta Cuaca dan Gempa Interaktif</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

  <script src="https://unpkg.com/leaflet-providers@1.13.0/leaflet-providers.js"></script>
  <script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>

  <link rel="stylesheet" href="static/styles.css">
</head>
<body>
  <div id="map"></div>
  <div id="koordinat-info"></div>
  <script>
    // --- URL API Dinamis & Portabel ---

    // 1. Dapatkan protokol (http: atau https:) secara otomatis
    const protocol = window.location.protocol;

    // 2. Dapatkan hostname (localhost atau 192.x.x.x) secara otomatis
    const hostname = window.location.hostname; 

    // 3. Tentukan port server Anda
    const port = '5000';

    // 4. Gabungkan semuanya. Ini akan menghasilkan http://... atau https://...
    // tergantung bagaimana halaman diakses.
    const baseUrl = `${protocol}//${hostname}:${port}`;

    document.addEventListener('DOMContentLoaded', function() {
      // Definisikan batas koordinat untuk Indonesia saja
      var southWest = L.latLng(-11.3, 94.7);
      var northEast = L.latLng(6.3, 141.3);
      var bounds = L.latLngBounds(southWest, northEast);

      // Inisialisasi peta, berpusat di Indonesia, dan batasi hanya Indonesia
      var map = L.map('map', {
        minZoom: 5,        // Batas zoom minimum di satu Indonesia
        maxZoom: 14,       // Batas zoom maks di area kecamatan
        maxBounds: bounds, // tetap dibatasi area
        maxBoundsViscosity: 1.0, // mencegah peta keluar dari batas
        preferCanvas: true // Gunakan canvas untuk rendering yang lebih baik
      }).setView([-2.5489, 118.0149], 5); // Pusat di Indonesia

      // Tambah tile layer tanpa label sebagai dasar peta
      L.tileLayer.provider('CartoDB.PositronNoLabels', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
      }).addTo(map);

      // Definisikan URL ke Vector Tile Server Lokal
      var vectorTileUrl = `${baseUrl}/tiles/{z}/{x}/{y}.pbf`;

      // Definisikan gaya (styling) untuk setiap layer administratif
      var vectorTileOptions = {
        vectorTileLayerStyles: {
          'batas_provinsi': function(properties, zoom) {
            if (zoom >=5 && zoom <= 7.99) { return { fill: true, fillColor: '#ff7800', fillOpacity: 0, stroke: true, color: '#8B4513', weight: 1.5, }; }
            else { return { stroke: false, fill: false }; }
          },
          'batas_kabupatenkota': function(properties, zoom) {
            if (zoom >= 8 && zoom <= 10.99) { return { fill: true, fillColor: '#3388ff', fillOpacity: 0, stroke: true, color: '#003366', weight: 1, }; }
            else { return { stroke: false, fill: false }; }
          },
          'batas_kecamatandistrik': function(properties, zoom) {
            if (zoom >= 11 && zoom <= 14) { return { fill: true, fillColor: '#44B500', fillOpacity: 0, stroke: true, color: '#276600', weight: 0.8, }; }
            else { return { stroke: false, fill: false }; }
          }
        },
        interactive: true // Mengizinkan interaksi seperti klik
      };

      // Buat layer VectorGrid dan tambahkan ke peta
      var vectorGridLayer = L.vectorGrid.protobuf(vectorTileUrl, vectorTileOptions)
        .on('click', function(e) {
          // ... (logika popup poligon Anda tetap sama) ...
          L.DomEvent.stop(e);
          var properties = e.layer.properties;
          console.log("Properti wilayah yang diklik:", properties);
          let tingkatWilayah = 'Tidak tersedia';
          let namaWilayah = 'Data tidak tersedia';
          if (properties && properties.TIPADM) {
            switch (Number(properties.TIPADM)) {
              case 3: tingkatWilayah = 'Kecamatan/Distrik'; namaWilayah = properties.WADMKC || 'Kecamatan tidak bernama'; break;
              case 2: tingkatWilayah = 'Kabupaten/Kota'; namaWilayah = properties.WADMKK || 'Kab/Kota tidak bernama'; break;
              case 1: tingkatWilayah = 'Provinsi'; namaWilayah = properties.WADMPR || 'Provinsi tidak bernama'; break;
              default: tingkatWilayah = 'Tipe administrasi tidak dikenali'; namaWilayah = 'Nama wilayah tidak dikenali';
            }
          }
          L.popup().setLatLng(e.latlng).setContent('<b>' + tingkatWilayah + ': </b>'
                                                  + namaWilayah 
                                                  + '<br><b>Suhu:</b> Placeholder°C' 
                                                  + '<br><b>Cuaca:</b> Placeholder' 
                                                  + '<br><b>Kelembapan:</b> Placeholder%'
                                                  + '<br><b>Terasa Seperti:</b> Placeholder°C'
                                                ).openOn(map);
          })
          .addTo(map);

        // Tambah layer label (hanya teks) di atas semua layer lain
        L.tileLayer.provider('CartoDB.PositronOnlyLabels', { maxZoom: 19, pane: 'overlayPane' }).addTo(map);

        // ================== LOGIKA PANGGILAN API & KLASTERISASI BARU ==================

        // --- Inisialisasi ---
        const markerClusterGroup = L.markerClusterGroup({ spiderfyOnMaxZoom: false, showCoverageOnHover: false, zoomToBoundsOnClick: false }).addTo(map);
        let weatherController;
        let clusterRequestController;
        let currentClusterPopup = null;
        let isPanningToDetail = false;
        let currentMarkersMap = new Map(); // "Otak" yang melacak semua marker di peta

        // --- Fungsi Helper ---
        const debounce = (func, delay) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; };
        const getColorForSuhu = (suhu) => { if (suhu > 30) return '#d43f3a'; if (suhu > 28) return '#f57f20'; return '#fde725'; };

        // --- Alur Kerja 1: Pembaruan Peta Umum ---

        // ================== LOGIKA PEMBARUAN PETA OPTIMIS ==================

        // --- Helper Functions untuk mengelola marker ---
        function createWeatherMarker(id, data) {
            const warnaSuhu = getColorForSuhu(data.suhu);
            const iconHTML = `<div class="weather-label"><span class="weather-dot" style="background-color: ${warnaSuhu};"></span><span class="weather-text">${data.nama}</span></div>`;
            const icon = L.divIcon({ className: 'custom-div-icon', html: iconHTML, iconAnchor: [8, 8] });
            const marker = L.marker([data.lat, data.lon], { icon: icon });
            marker.options.markerType = 'weather';
            marker.options.wilayahId = id;
            
            const popupContent = `<b>${data.nama}</b><br>Suhu: ${data.suhu.toFixed(1)}°C<br>Cuaca: ${data.cuaca}<br>Kelembapan: ${data.kelembapan}%<br>Terasa Seperti: ${data.terasa.toFixed(1)}°C`;
            marker.bindPopup(popupContent);
            
            markerClusterGroup.addLayer(marker);
            currentMarkersMap.set(id, marker);
        }

        function updateWeatherMarker(marker, data) {
            // 1. Perbarui Ikon (jika ada perubahan visual)
            const warnaSuhu = getColorForSuhu(data.suhu);
            const newIconHTML = `<div class="weather-label"><span class="weather-dot" style="background-color: ${warnaSuhu};"></span><span class="weather-text">${data.nama}</span></div>`;
            const newIcon = L.divIcon({ className: 'custom-div-icon', html: newIconHTML, iconAnchor: [8, 8] });
            marker.setIcon(newIcon);

            // 2. Perbarui Konten Popup
            const newPopupContent = `<b>${data.nama}</b><br>Suhu: ${data.suhu.toFixed(1)}°C<br>Cuaca: ${data.cuaca}<br>Kelembapan: ${data.kelembapan}%<br>Terasa Seperti: ${data.terasa.toFixed(1)}°C`;
            marker.setPopupContent(newPopupContent);

            // 3. Jika popup sedang terbuka, perbarui isinya secara real-time
            if (marker.isPopupOpen()) {
                marker.getPopup().setContent(newPopupContent);
            }
        }

        function createProvinsiMarker(id, data) {
            const iconHTML = `<div class="weather-label"><span class="weather-text">${data.nama}</span></div>`;
            const icon = L.divIcon({ className: 'custom-div-icon', html: iconHTML, iconAnchor: [8, 8] });
            const marker = L.marker([data.lat, data.lon], { icon: icon });
            marker.options.markerType = 'provinsi';
            marker.options.wilayahId = id;
            marker.bindPopup(`<b>Provinsi:</b><br>${data.nama}`);
            
            markerClusterGroup.addLayer(marker);
            currentMarkersMap.set(id, marker);
        }

        // Untuk provinsi, tidak ada data dinamis (suhu, dll.) yang perlu di-update.
        // Jadi kita hanya perlu fungsi create dan remove.

        function removeMarker(id) {
            const marker = currentMarkersMap.get(id);
            if (marker) {
                markerClusterGroup.removeLayer(marker);
                currentMarkersMap.delete(id);
            }
        }


        // --- Fungsi Utama Pembaruan Peta ---
        function perbaruiPeta() {
            if (isPanningToDetail) return;
            if (weatherController) weatherController.abort();
            weatherController = new AbortController();
            const signal = weatherController.signal;
            const bounds = map.getBounds();
            const bbox = bounds.toBBoxString();
            const zoom = map.getZoom();

            // HAPUS PEMBERSIHAN TOTAL. JANGAN GUNAKAN clearLayers() LAGI.
            // markerClusterGroup.clearLayers(); 

            if (currentClusterPopup) {
                currentClusterPopup.remove();
                currentClusterPopup = null;
            }

            if (zoom <= 7.99) {
                fetch(`${baseUrl}/api/provinsi-info`, { signal })
                    .then(response => response.json())
                    .then(provinsiData => {
                        // Konversi array ke format objek agar konsisten
                        const dataObj = provinsiData.reduce((obj, item) => {
                            obj[item.id] = item;
                            return obj;
                        }, {});

                        const newIds = new Set(Object.keys(dataObj));

                        // 1. Tambah/Perbarui Marker yang Terlihat
                        for (const id of newIds) {
                            if (!currentMarkersMap.has(id)) {
                                createProvinsiMarker(id, dataObj[id]);
                            }
                        }

                        // 2. Hapus Marker yang Tidak Lagi Terlihat
                        for (const id of currentMarkersMap.keys()) {
                            if (!newIds.has(id)) {
                                removeMarker(id);
                            }
                        }
                    }).catch(e => { if (e.name !== 'AbortError') console.error('Gagal ambil data provinsi:', e); });
            } else {
                fetch(`${baseUrl}/api/data-cuaca?bbox=${bbox}&zoom=${zoom}`, { signal })
                    .then(response => response.json())
                    .then(dataCuaca => {
                        const newIds = new Set(Object.keys(dataCuaca));

                        // 1. Tambah/Perbarui Marker yang Terlihat
                        for (const id of newIds) {
                            const wilayahData = dataCuaca[id];
                            if (currentMarkersMap.has(id)) {
                                // Marker sudah ada -> UPDATE
                                updateWeatherMarker(currentMarkersMap.get(id), wilayahData);
                            } else {
                                // Marker belum ada -> CREATE
                                createWeatherMarker(id, wilayahData);
                            }
                        }

                        // 2. Hapus Marker yang Tidak Lagi Terlihat
                        for (const id of currentMarkersMap.keys()) {
                            if (!newIds.has(id)) {
                                removeMarker(id);
                            }
                        }
                    }).catch(e => { if (e.name !== 'AbortError') console.error('Gagal ambil data cuaca:', e); });
            }
        }
        const perbaruiPetaDebounced = debounce(perbaruiPeta, 500);
        map.on('moveend', perbaruiPetaDebounced);
        perbaruiPetaDebounced();

        // --- Alur Kerja 2: Inspeksi Klaster (Klik Instan) ---
        markerClusterGroup.on('clusterclick', function (e) {
        console.log('[DEBUG] Event clusterclick terpicu!'); // LOG 1

        if (isPanningToDetail) return;
        e.originalEvent.preventDefault();
        e.originalEvent.stopPropagation();

        if (currentClusterPopup) currentClusterPopup.remove();
        if (clusterRequestController) clusterRequestController.abort();

        const childMarkers = e.layer.getAllChildMarkers();
        const clusterLatLng = e.layer.getLatLng();
        const clusterBox = document.createElement('div');
        clusterBox.className = 'cluster-box';

        const handleItemClick = (marker) => {
            // 1. Ekstrak semua informasi yang kita butuhkan dari marker LAMA.
            const targetLatLng = marker.getLatLng();
            const popupContent = marker.getPopup().getContent(); // Ambil konten HTML-nya

            if (currentClusterPopup) {
                currentClusterPopup.remove();
                currentClusterPopup = null;
            }

            // Matikan listener umum untuk mencegah pembaruan peta otomatis.
            map.off('moveend', perbaruiPetaDebounced);

            map.once('moveend', function () {
                // 2. JANGAN gunakan marker.openPopup().
                // Sebagai gantinya, buat popup BARU yang independen.
                L.popup({
                    maxWidth: 400,
                    closeButton: true
                })
                .setLatLng(targetLatLng) // Di lokasi yang kita inginkan
                .setContent(popupContent) // Dengan konten yang kita simpan tadi
                .openOn(map); // Buka langsung di peta

                // Aktifkan kembali listener umum setelah semuanya selesai.
                setTimeout(() => {
                    map.on('moveend', perbaruiPetaDebounced);
                }, 100);
            });

            // 3. Mulai proses panning seperti biasa.
            map.panTo(targetLatLng);
        };
        
        const markerType = childMarkers[0].options.markerType;

        if (markerType === 'provinsi') {
            childMarkers.forEach(marker => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cluster-item interactive-item';
                const namaProvinsi = marker.getPopup().getContent().split('<br>')[1];
                itemDiv.innerHTML = `<div class="weather-label"><span class="weather-text">${namaProvinsi}</span></div>`;
                itemDiv.addEventListener('click', () => handleItemClick(marker));
                clusterBox.appendChild(itemDiv);
            });

            currentClusterPopup = L.popup({ maxWidth: 400, closeButton: true })
                .setLatLng(clusterLatLng)
                .setContent(clusterBox)
                .openOn(map);

        } else if (markerType === 'weather') {
            const idsToFetch = childMarkers.map(marker => marker.options.wilayahId);
            const loadingPopup = L.popup().setLatLng(clusterLatLng).setContent('Memuat data...').openOn(map);
            clusterRequestController = new AbortController();

            fetch(`${baseUrl}/api/data-by-ids?ids=${idsToFetch.join(',')}`, { signal: clusterRequestController.signal })
                .then(response => response.json())
                .then(dataDetailCuaca => {
                    loadingPopup.remove();
                    
                    for (const id in dataDetailCuaca) {
                        const data = dataDetailCuaca[id];
                        const originalMarker = childMarkers.find(m => m.options.wilayahId == id);
                        if (!originalMarker) continue;

                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'cluster-item interactive-item';
                        const warnaSuhu = getColorForSuhu(data.suhu);
                        itemDiv.innerHTML = `<div class="weather-label"><span class="weather-dot" style="background-color: ${warnaSuhu};"></span><span class="weather-text">${data.nama}</span></div>`;
                        itemDiv.addEventListener('click', () => handleItemClick(originalMarker));
                        clusterBox.appendChild(itemDiv);
                    }

                    currentClusterPopup = L.popup({ maxWidth: 400, closeButton: true })
                        .setLatLng(clusterLatLng)
                        .setContent(clusterBox)
                        .openOn(map);
                })
                .catch(error => {
                    if (error.name !== 'AbortError') {
                        loadingPopup.setContent('Gagal memuat data.');
                    }
                });
        }
    });
      
        // Ambil elemen div untuk info koordinat
        var infoKoordinat = document.getElementById('koordinat-info');
        // ... (sisa kode info koordinat Anda tidak berubah) ...
        infoKoordinat.innerHTML = 'Geser kursor di atas peta';
        map.on('mousemove', function(e) {
          var lat = e.latlng.lat.toFixed(5);
          var lng = e.latlng.lng.toFixed(5);
          infoKoordinat.innerHTML = 'Latitude: ' + lat + ' | Longitude: ' + lng;
        });
        map.on('mouseout', function() {
          infoKoordinat.innerHTML = 'Geser kursor di atas peta';
        });
    });
  </script>
</body>
</html>