<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Peta Cuaca dan Gempa Interaktif</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

  <script src="https://unpkg.com/leaflet-providers@1.13.0/leaflet-providers.js"></script>
  <script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>

  <link rel="stylesheet" href="static/styles.css">
</head>
<body>
  <div id="map"></div>
  <div id="koordinat-info"></div>
  <script>
  // Definisikan batas koordinat untuk Indonesia saja
  var southWest = L.latLng(-11.3, 94.7);
  var northEast = L.latLng(6.3, 141.3);
  var bounds = L.latLngBounds(southWest, northEast);

  // Inisialisasi peta, berpusat di Indonesia, dan batasi hanya Indonesia
  var map = L.map('map', {
    minZoom: 5,        // Batas zoom minimum di satu Indonesia
    maxZoom: 14,       // Batas zoom maks di area kecamatan
    maxBounds: bounds, // tetap dibatasi area
    maxBoundsViscosity: 1.0 // mencegah peta keluar dari batas
  }).setView([-2.5489, 118.0149], 5); // Pusat di Indonesia

  // Ambil elemen div untuk info koordinat
  var infoKoordinat = document.getElementById('koordinat-info');
  infoKoordinat.innerHTML = 'Geser kursor di atas peta';

  // Tambahkan event listener untuk menampilkan koordinat saat mouse bergerak di atas peta
  map.on('mousemove', function(e) {
    //format teks dan tampilkan dalam div
    var lat = e.latlng.lat.toFixed(5);
    var lng = e.latlng.lng.toFixed(5);
    infoKoordinat.innerHTML = 
      'Latitude: ' + lat + 
      ' | Longitude: ' + lng;
  });

  // Tambahkan event listener saat mouse keluar dari peta
  map.on('mouseout', function() {
    infoKoordinat.innerHTML = 'Geser kursor di atas peta';
  });

  // Tambah tile layer tanpa label sebagai dasar peta
  L.tileLayer.provider('CartoDB.PositronNoLabels', {
    maxZoom: 19,
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
  }).addTo(map);

  // Definisikan URL ke Vector Tile Server Lokal
  var vectorTileUrl = 'http://localhost:5000/tiles/{z}/{x}/{y}.pbf';

  // Definisikan gaya (styling) untuk setiap layer administratif
  var vectorTileOptions = {
    vectorTileLayerStyles: {
      // Layer Provinsi: Selalu terlihat
      'batas_provinsi': function(properties, zoom) {
        if (zoom <= 7) {
          return {
          fill: true,
          fillColor: '#ff7800', // Oranye
          fillOpacity: 0,
          stroke: true,
          color: '#8B4513',
          weight: 1.5,
          };
        }
        else {
          return { stroke: false, fill: false };
        }
      },
      
      // Layer Kabupaten/Kota: Hanya terlihat di zoom 8 ke atas
      'batas_kabupatenkota': function(properties, zoom) {
        if (zoom >= 8 && zoom <= 10) {
          return {
            fill: true,
            fillColor: '#3388ff', // Biru
            fillOpacity: 0,
            stroke: true,
            color: '#003366',
            weight: 1,                           
          };
        } else {
          // Sembunyikan layer jika zoom < 8 atau > 10
          return { stroke: false, fill: false };
        }
      },

      // Layer Kecamatan: Hanya terlihat di zoom 11 ke atas
      'batas_kecamatandistrik': function(properties, zoom) {
        if (zoom >= 11 && zoom <= 14) {
          return {
            fill: true,
            fillColor: '#44B500', // Hijau
            fillOpacity: 0,
            stroke: true,
            color: '#276600',
            weight: 0.8,
          };
        } else {
          // Sembunyikan layer jika zoom < 11
          return { stroke: false, fill: false };
        }
      }
    },
    interactive: true // Mengizinkan interaksi seperti klik
  };

  // Buat layer VectorGrid dan tambahkan ke peta
  var vectorGridLayer = L.vectorGrid.protobuf(vectorTileUrl, vectorTileOptions)
    .on('click', function(e) {
      // Hentikan event agar tidak 'merembes' ke peta di bawahnya jika perlu
      L.DomEvent.stop(e);

      // Fungsi untuk menampilkan popup saat area diklik
      var properties = e.layer.properties;
      // Aktifkan ini untuk melihat semua properti yang tersedia di console browser (F12)
      // console.log("Properti wilayah yang diklik:", properties); 

      // Pastikan nama properti (WADMPR, dll) sesuai dengan data Anda
      let tingkatWilayah = 'Tidak tersedia';
      let namaWilayah = 'Data tidak tersedia';
      // Pastikan 'properties' dan 'TIPADM' ada sebelum dicek
      if (properties && properties.TIPADM) {
        // Menggunakan switch lebih rapi untuk banyak kondisi
        // Mengubah nilai ke Number() untuk memastikan perbandingan dengan angka berhasil
        switch (Number(properties.TIPADM)) {
          case 3:
            tingkatWilayah = 'Kecamatan/Distrik';
            namaWilayah = properties.WADMKC || 'Kecamatan tidak bernama';
            break;
          case 2:
            tingkatWilayah = 'Kabupaten/Kota';
            namaWilayah = properties.WADMKK || 'Kab/Kota tidak bernama';
            break;
          case 1:
            tingkatWilayah = 'Provinsi';
            namaWilayah = properties.WADMPR || 'Provinsi tidak bernama';
            break;
          default:
            tingkatWilayah = 'Tipe administrasi tidak dikenali';
            namaWilayah = 'Nama wilayah tidak dikenali';
        }
      }
      
      // Tampilkan popup di lokasi klik dengan nama wilayah
      L.popup()
        .setLatLng(e.latlng)
        .setContent('<p><strong>' + tingkatWilayah + ':</strong> ' + namaWilayah + '</p>'
          + '<p><strong>Cuaca:</strong> ' + 'Cerah (Placeholder)' + '</p>'
          + '<p><strong>Suhu:</strong> ' + '30Â°C (Placeholder)' + '</p>'
          + '<p><strong>Kelembaban:</strong> ' + '70% (Placeholder)' + '</p>'
        )
        .openOn(map);
      })
      .addTo(map);

    // Tambah layer label (hanya teks) di atas semua layer lain
    L.tileLayer.provider('CartoDB.PositronOnlyLabels', {
        maxZoom: 19,
        pane: 'overlayPane'
    }).addTo(map);
  </script>
</body>
</html>