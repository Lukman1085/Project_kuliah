<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Cuaca Gempa Interaktif</title>
    
    <link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
    <script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>
    
    <link rel="stylesheet" href="static/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.10/css/weather-icons.min.css">
</head>
<body>
    <div id="map"></div>
    <div id="koordinat-info"></div>
    <div id="global-loading-spinner">Memuat data cuaca...</div>

    <div id="detail-sidebar" role="dialog" aria-modal="true" aria-labelledby="sidebar-location-name">
        <div id="sidebar-header">
            <h2 id="sidebar-location-name">Detail Lokasi</h2>
            <button id="close-sidebar-btn" aria-label="Tutup detail lokasi">&times;</button>
        </div>
        <div id="sidebar-content">
            <div id="sidebar-placeholder">Pilih satu wilayah di peta.</div>
            <div id="sidebar-loading" style="display: none;">
                <i class="wi wi-day-sunny"></i> Memuat data...
            </div>
            <div id="sidebar-weather-details" style="display: none;">
                <!-- [PERBAIKAN] Menambahkan div untuk waktu di sidebar -->
                <div id="sidebar-current-conditions">
                    <div id="sidebar-current-time" style="font-size: 0.9rem; color: #555; margin-bottom: 8px; text-align: center;">...</div>
                    <i id="sidebar-current-icon" class="wi wi-na"></i>
                    <div id="sidebar-current-temp">-Â°C</div>
                    <div id="sidebar-current-desc">...</div>
                    <div id="sidebar-current-feelslike">Terasa ...Â°C</div>
                    {/* */}
                    <div id="sidebar-current-humidity" style="font-size: 1rem; color: #555;">Kelembapan: ...%</div>
                    <div id="sidebar-current-precipitation" style="font-size: 1rem; color: #555;">Presipitasi: ...%</div>
                    <div id="sidebar-current-wind" style="font-size: 1rem; color: #555;">Angin: ... m/s</div>
                </div>
                <h3 id="sidebar-daily-forecast-title">Prakiraan 14 Hari</h3>
                <div id="sidebar-daily-forecast-list">
                    </div>
            </div>
            <div id="sidebar-province-details" style="display: none;">
                </div>
        </div>
    </div>
    <button id="sidebar-toggle-btn" aria-label="Buka detail lokasi">&gt;</button>
    <div id="datetime-picker-container">
        <div class="datetime-row">
            <button id="prev-day-btn" aria-label="Hari Sebelumnya">&lt;</button>
            <span id="date-display">Memuat...</span>
            <button id="calendar-btn" aria-label="Pilih Tanggal">ðŸ“…</button>
            <button id="next-day-btn" aria-label="Hari Berikutnya">&gt;</button>
        </div>
        <div class="datetime-row">
            <button id="prev-hour-btn" aria-label="Jam Sebelumnya">&lt;</button>
            <span id="hour-display">--:--</span>
            <button id="next-hour-btn" aria-label="Jam Berikutnya">&gt;</button>
        </div>
        <div id="calendar-popup">
            <button id="calendar-prev-month" aria-label="Bulan Sebelumnya">&lt;</button>
            <span id="calendar-month-year">Oktober 2025</span>
            <button id="calendar-next-month" aria-label="Bulan Berikutnya">&gt;</button>
            <div id="calendar-grid">
                {/* */}
                {/* */}
            </div>
        </div>
    </div>
    <script>
        const protocol = window.location.protocol;
        const hostname = window.location.hostname;
        const port = '5000';
        const baseUrl = `${protocol}//${hostname}:${port}`;

        // ================================================================
        // 1. STATE MANAGEMENT & VARIABEL GLOBAL
        // ================================================================

        const appState = {
            selectedTimeIndex: -1, 
            baseTimestampUTC: null, 
            calendarDisplayMonth: new Date().getMonth(),
            calendarDisplayYear: new Date().getFullYear(),
            isLoading: false,
            isClickLoading: false,
            activeLocationId: null,
            activeLocationName: null,
            activeLocationData: null,
            isSidebarOpen: false,
            previousActiveLocationId: null,
            activeTimezone: null,
        };

        let WMO_CODE_MAP = {};
        const clientWeatherCache = new Map();
        const inflightIds = new Set();

        // Variabel elemen UI
        let sidebarEl, toggleBtnEl, closeBtnEl, sidebarContentEl, sidebarLocationNameEl;
        let sidebarPlaceholderEl, sidebarLoadingEl, sidebarWeatherDetailsEl, sidebarProvinceDetailsEl;
        let prevDayBtn, nextDayBtn, dateDisplay, calendarBtn, prevHourBtn, nextHourBtn, hourDisplay;
        let calendarPopup, calendarGrid, calendarMonthYear, calendarPrevMonthBtn, calendarNextMonthBtn;
        let map; // Referensi MapLibre

        // ===== PENGELOLA POPUP TERPUSAT (V2 - LEBIH AMAN) =====
        const popupManager = {
            _currentInstance: null,
            _internalCloseFlag: false,

            open: function(lngLat, contentHTML, options = { maxWidth: '260px' }) {
                this.close(true);
                if (!Array.isArray(lngLat) || lngLat.length !== 2 || typeof lngLat[0] !== 'number' || typeof lngLat[1] !== 'number' || isNaN(lngLat[0]) || isNaN(lngLat[1])) { console.error("Invalid lngLat:", lngLat); return null; }
                try {
                    const newPopup = new maplibregl.Popup(options).setLngLat(lngLat);
                    if (typeof contentHTML === 'string') { newPopup.setHTML(contentHTML); }
                    else if (contentHTML instanceof HTMLElement) { newPopup.setDOMContent(contentHTML); }
                    else { newPopup.setHTML("Invalid content."); }
                    this._currentInstance = newPopup;
                    newPopup.once('close', () => {
                         const wasInternal = popupManager._internalCloseFlag;
                         popupManager._internalCloseFlag = false;
                         if (popupManager._currentInstance === newPopup) {
                             popupManager._currentInstance = null;
                         } 
                         if (!wasInternal) {
                             resetActiveLocationState();
                         }
                    });
                    newPopup.addTo(map);
                    return newPopup;
                } catch (e) {
                     console.error("Failed to create/add popup:", e, " LngLat:", lngLat);
                     if (this._currentInstance === newPopup) this._currentInstance = null;
                     return null;
                }
            },

            close: function(isInternalAction = false) {
                if (this._currentInstance) {
                    const popupToClose = this._currentInstance;
                    this._internalCloseFlag = isInternalAction;
                    try {
                        if (popupToClose.isOpen()) {
                            popupToClose.remove();
                        } else {
                            if(this._currentInstance === popupToClose){
                                 this._currentInstance = null; this._internalCloseFlag = false;
                            }
                        }
                    } catch(e) {
                         console.warn("Error removing popup:", e);
                         if(this._currentInstance === popupToClose){ this._currentInstance = null; }
                         this._internalCloseFlag = false;
                    }
                } else { this._internalCloseFlag = false; }
            },

            isOpen: function() { return !!this._currentInstance && this._currentInstance.isOpen(); },
            getElement: function() { return (this._currentInstance && this._currentInstance.isOpen()) ? this._currentInstance.getElement() : null; },
            getInstance: function() { return this._currentInstance; },
            setHTML: function(htmlContent) { if (this._currentInstance && this._currentInstance.isOpen() && typeof htmlContent === 'string') { try { this._currentInstance.setHTML(htmlContent); } catch (e) { console.error("Err setHTML:", e); } } },
            setDOMContent: function(domElement) { if (this._currentInstance && this._currentInstance.isOpen() && domElement instanceof HTMLElement) { try { this._currentInstance.setDOMContent(domElement); } catch (e) { console.error("Err setDOMContent:", e); } } }
        };
        // ===== AKHIR PENGELOLA POPUP =====

        // ================================================================
        // 2. FUNGSI HELPER
        // ================================================================

        /** Menerjemahkan kode WMO ke deskripsi & ikon Weather Icons */
        function getWeatherInfo(weather_code, is_day) {
            const default_info = ["N/A", "wi-na"];
            if (weather_code === undefined || weather_code === null) { return { deskripsi: default_info[0], ikon: `wi ${default_info[1]}` }; }
            const info = WMO_CODE_MAP[weather_code];
            if (!info) { return { deskripsi: `Kode ${weather_code}`, ikon: `wi ${default_info[1]}` }; }
            const deskripsi = info[0] || default_info[0];
            const useDayIcon = (is_day === 1 || is_day === true);
            const icon_class = useDayIcon ? (info[1] || info[2]) : (info[2] || info[1]);
            return { deskripsi: deskripsi, ikon: `wi ${icon_class || default_info[1]}` };
        }

        /** Memformat timestamp UTC ke string tanggal & waktu di timezone target. */
        function formatTimestamp(timestampUTC, timeZone) {
            if (timestampUTC === null || timestampUTC === undefined) return "--:--";
            const tz = timeZone || Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
            try {
                const date = new Date(timestampUTC);
                if (isNaN(date.getTime())) throw new Error("Invalid Date");
                // Format lengkap untuk popup/sidebar
                const options = { weekday: 'long', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit', timeZone: tz, hour12: false };
                return new Intl.DateTimeFormat('id-ID', options).format(date);
            } catch (e) { console.error("Error formatting timestamp:", timestampUTC, tz, e); return "Error Waktu"; }
        }

        /** Memformat objek Date ke string tanggal relatif/absolut untuk picker */
        function formatDateDisplayFromDate(dateObj, displayTimeZone) {
             if (!dateObj || isNaN(dateObj.getTime())) return "Error Tgl";
             const tz = displayTimeZone || Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';

             // Bandingkan tanggal UTC
             const now = new Date();
             const todayUTCYear = now.getUTCFullYear();
             const todayUTCMonth = now.getUTCMonth();
             const todayUTCDate = now.getUTCDate();

             const targetUTCYear = dateObj.getUTCFullYear();
             const targetUTCMonth = dateObj.getUTCMonth();
             const targetUTCDate = dateObj.getUTCDate();

             if (targetUTCYear === todayUTCYear && targetUTCMonth === todayUTCMonth && targetUTCDate === todayUTCDate) return "Hari Ini";

             const yesterdayUTC = new Date(Date.UTC(todayUTCYear, todayUTCMonth, todayUTCDate - 1));
             if (targetUTCYear === yesterdayUTC.getUTCFullYear() && targetUTCMonth === yesterdayUTC.getUTCMonth() && targetUTCDate === yesterdayUTC.getUTCDate()) return "Kemarin";

             const tomorrowUTC = new Date(Date.UTC(todayUTCYear, todayUTCMonth, todayUTCDate + 1));
             if (targetUTCYear === tomorrowUTC.getUTCFullYear() && targetUTCMonth === tomorrowUTC.getUTCMonth() && targetUTCDate === tomorrowUTC.getUTCDate()) return "Besok";

             // Format absolut ke timezone display
             const options = { weekday: 'long', day: 'numeric', month: 'short', timeZone: tz };
             try { return new Intl.DateTimeFormat('id-ID', options).format(dateObj); }
             catch (e) { console.error("Error formatting date display:", dateObj, tz, e); return "Error Tgl"; }
        }

         /** Memformat objek Date ke string jam "HH:00" untuk picker */
         function formatHourDisplayFromDate(dateObj, displayTimeZone) {
              if (!dateObj || isNaN(dateObj.getTime())) return "--:--";
              const tz = displayTimeZone || Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
              const options = { hour: '2-digit', minute: '2-digit', timeZone: tz, hour12: false };
              try { return new Intl.DateTimeFormat('id-ID', options).format(dateObj); }
              catch (e) { console.error("Error formatting hour display:", dateObj, tz, e); return "--:--"; }
         }


        /** Memformat YYYY-MM-DD ke nama hari & tanggal lokal */
        function formatDayOnly(dateString, timeZone) {
             if (!dateString) return "Error Tgl";
             const tz = timeZone || Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
             try {
                const dateParts = dateString.split('-');
                if (dateParts.length !== 3) throw new Error("Invalid format");
                const date = new Date(Date.UTC(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]), 12));
                if (isNaN(date.getTime())) throw new Error("Invalid Date");
                const options = { weekday: 'long', day: 'numeric', month: 'short', timeZone: tz };
                return new Intl.DateTimeFormat('id-ID', options).format(date);
            } catch (e) { console.error("Error formatting day:", dateString, tz, e); return dateString; }
        }

        /** Menghitung timestamp UTC dari string waktu lokal + offset */
        function calculateBaseTimestamp(localTimeString, offsetSeconds) {
            if (localTimeString === undefined || localTimeString === null || offsetSeconds === undefined) {
                 console.warn("Missing time or offset, cannot calculate base TS", localTimeString, offsetSeconds);
                 return null;
            }
            try {
                const offsetSign = offsetSeconds >= 0 ? '+' : '-';
                const offsetHours = Math.floor(Math.abs(offsetSeconds) / 3600);
                const offsetMinutes = Math.floor((Math.abs(offsetSeconds) % 3600) / 60);
                const offsetString = `${offsetSign}${String(offsetHours).padStart(2, '0')}:${String(offsetMinutes).padStart(2, '0')}`;
                const fullIsoString = localTimeString + offsetString;
                const ts = new Date(fullIsoString).getTime();
                return isNaN(ts) ? null : ts;
            } catch (e) {
                console.error("Error calculating base TS:", e);
                return null;
            }
        }

        /** Fungsi Debounce */
        const debounce = (func, delay) => {
             let timeout;
             return (...args) => {
                 clearTimeout(timeout);
                 timeout = setTimeout(() => func.apply(this, args), delay);
             };
         };

        /**
         * Mereset state aplikasi terkait lokasi aktif.
         */
        function resetActiveLocationState() {
            console.log("Resetting active location state...");
            const idToReset = appState.activeLocationId;
            if (idToReset) { removeActiveMarkerHighlight(idToReset); }
            appState.activeLocationId = null;
            appState.activeLocationName = null;
            appState.activeLocationData = null;
            appState.isClickLoading = false;
            appState.previousActiveLocationId = null;
            
            // --- RESET WAKTU KE DEFAULT BROWSER ---
            const browserOffsetMinutes = new Date().getTimezoneOffset();
            const browserOffsetSeconds = browserOffsetMinutes * -60;
            
            const now = new Date();
            const sevenDaysAgoBrowser = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
            const year = sevenDaysAgoBrowser.getFullYear();
            const month = String(sevenDaysAgoBrowser.getMonth() + 1).padStart(2, '0');
            const day = String(sevenDaysAgoBrowser.getDate()).padStart(2, '0');
            const localTimeString = `${year}-${month}-${day}T00:00`;

            const defaultBaseTS = calculateBaseTimestamp(localTimeString, browserOffsetSeconds);

            if (defaultBaseTS) {
                 appState.activeTimezone = null; // Reset display timezone
                 appState.baseTimestampUTC = defaultBaseTS; // Reset base TS
            } else {
                 console.warn("Could not calculate default base TS for browser. Time display may be inconsistent.");
                 appState.activeTimezone = null; 
            }
            // --- AKHIR RESET WAKTU ---

            if (appState.isSidebarOpen) { renderSidebarContent(); }
            updateTimeSelectionAndUI(); // Update display picker ke kondisi default
        }

        // --- FUNGSI HELPER BARU UNTUK WAKTU ---

        /** Mendapatkan timestamp UTC dari index 0, fallback jika cache kosong */
        function getBaseTimestampUTC() {
            if (appState.baseTimestampUTC) return appState.baseTimestampUTC;
            
            for (const data of clientWeatherCache.values()) {
                if (data?.baseTimestampUTC) { 
                     appState.baseTimestampUTC = data.baseTimestampUTC; 
                     return data.baseTimestampUTC;
                }
            }
            console.warn("Base timestamp could not be determined from state or cache.");
            return null; 
        }

        /** Mendapatkan timestamp UTC untuk indeks tertentu (bisa di-override baseTs) */
        function getTimestampUTCFromIndex(index, overrideBaseTs = null) {
             const baseTs = overrideBaseTs || getBaseTimestampUTC(); 
             if (baseTs === null || index < 0 || index > 335) {
                 return null;
             }
             return baseTs + (index * 3600000); // index * 1 jam
        }

        /** Mencari indeks array terdekat untuk timestamp UTC target */
        function findIndexForTimestamp(targetTimestampUTC) {
            const baseTs = getBaseTimestampUTC();
            if (baseTs === null) return -1; 

            const maxIndex = 335; 
            const diffHours = Math.round((targetTimestampUTC - baseTs) / 3600000);
            return Math.max(0, Math.min(maxIndex, diffHours));
        }


        // --- FUNGSI HELPER BARU UNTUK KALENDER ---

        /** Menampilkan atau menyembunyikan popup kalender */
        function toggleCalendar() {
            if (!calendarPopup) return;
            const isOpen = calendarPopup.style.display === 'block';
            if (isOpen) {
                calendarPopup.style.display = 'none';
                document.removeEventListener('click', closeCalendarOnClickOutside);
            } else {
                renderCalendar();
                calendarPopup.style.display = 'block';
                setTimeout(() => { document.addEventListener('click', closeCalendarOnClickOutside, { once: true }); }, 0);
            }
        }

        /** Menutup kalender jika klik terjadi di luar elemennya */
        function closeCalendarOnClickOutside(event) {
             if (calendarPopup && calendarPopup.style.display === 'block' &&
                 !calendarPopup.contains(event.target) && event.target !== calendarBtn) {
                 calendarPopup.style.display = 'none';
             } else if (calendarPopup && calendarPopup.style.display === 'block') {
                  setTimeout(() => { document.addEventListener('click', closeCalendarOnClickOutside, { once: true }); }, 0);
             }
        }

        /** Merender isi kalender untuk bulan dan tahun tertentu */
        function renderCalendar() {
             if (!calendarGrid || !calendarMonthYear) return;
             const displayMonth = appState.calendarDisplayMonth;
             const displayYear = appState.calendarDisplayYear;
             const displayDate = new Date(displayYear, displayMonth, 1);
             calendarMonthYear.textContent = new Intl.DateTimeFormat('id-ID', { month: 'long', year: 'numeric' }).format(displayDate);
             calendarGrid.innerHTML = '';
             const daysHeader = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
             daysHeader.forEach(day => { const h=document.createElement('div'); h.className='calendar-day-header'; h.textContent=day; calendarGrid.appendChild(h); });

             const now = new Date();
             const startTimestamp = getTimestampUTCFromIndex(0); 
             const endTimestamp = getTimestampUTCFromIndex(335); 

             if (startTimestamp === null || endTimestamp === null) {
                 calendarGrid.innerHTML = '<div style="grid-column: span 7; color: red;">Error: Data waktu tidak tersedia.</div>';
                 return;
             }
             const startDate = new Date(startTimestamp); startDate.setUTCHours(0,0,0,0); 
             const endDate = new Date(endTimestamp); endDate.setUTCHours(23,59,59,999); 

             const firstOfMonth = new Date(displayYear, displayMonth, 1);
             const dayOfWeek = firstOfMonth.getDay();
             const lastDayPrevMonth = new Date(displayYear, displayMonth, 0).getDate();
             
             // Tambahkan tanggal dari bulan sebelumnya
             for (let i = dayOfWeek - 1; i >= 0; i--) {
                 const day = lastDayPrevMonth - i;
                 const cell = document.createElement('div');
                 cell.className = 'calendar-date other-month disabled';
                 cell.textContent = day;
                 calendarGrid.appendChild(cell);
             }
             // Tambahkan tanggal dari bulan display
             const daysInMonth = new Date(displayYear, displayMonth + 1, 0).getDate();
             for (let day = 1; day <= daysInMonth; day++) {
                 const date = new Date(Date.UTC(displayYear, displayMonth, day, 12));
                 const dateTimestamp = date.getTime();
                 const dateButton = document.createElement('button');
                 dateButton.className = 'calendar-date';
                 dateButton.textContent = day;
                 
                 if (dateTimestamp >= startDate.getTime() && dateTimestamp <= endDate.getTime()) {
                      const targetIndex = findIndexForTimestamp(dateTimestamp);
                      dateButton.dataset.index = targetIndex; 
                      dateButton.onclick = (e) => { e.stopPropagation(); handleCalendarDateClick(targetIndex); };

                      if (date.getUTCDate() === now.getUTCDate() && date.getUTCMonth() === now.getUTCMonth() && date.getUTCFullYear() === now.getUTCFullYear()) {
                          dateButton.classList.add('today');
                      }
                      const currentDayIndex = Math.floor(appState.selectedTimeIndex / 24); 
                      const buttonDayIndex = Math.floor(targetIndex / 24); 
                      if (currentDayIndex === buttonDayIndex) {
                           dateButton.classList.add('selected');
                      }
                 } else {
                     dateButton.classList.add('disabled');
                     dateButton.disabled = true;
                 }
                 calendarGrid.appendChild(dateButton);
             }
             // Tambahkan tanggal dari bulan berikutnya
             const totalCells = dayOfWeek + daysInMonth;
             const remainingCells = Math.max(0, (7 * 6) - totalCells); 
             for (let day = 1; day <= remainingCells; day++) {
                 const cell = document.createElement('div');
                 cell.className = 'calendar-date other-month disabled';
                 cell.textContent = day;
                 calendarGrid.appendChild(cell);
                  if (calendarGrid.children.length >= 42 + daysHeader.length) break;
             }
         }

        /** [PERBAIKAN UX] Menangani klik kalender (mempertahankan jam) */
        function handleCalendarDateClick(targetIndex) {
            console.log("Calendar date clicked, target index (for 12:00):", targetIndex);
            
            const currentHourInDay = appState.selectedTimeIndex % 24; // Jam 0-23
            const targetDayIndex = Math.floor(targetIndex / 24); // Hari 0-13
            const newIndex = (targetDayIndex * 24) + currentHourInDay;

            appState.selectedTimeIndex = Math.max(0, Math.min(335, newIndex)); 

            calendarPopup.style.display = 'none'; 
            document.removeEventListener('click', closeCalendarOnClickOutside);
            updateTimeSelectionAndUI(); 
        }

        /** Mengubah bulan yang ditampilkan di kalender */
        function changeCalendarMonth(direction) {
            let newMonth = appState.calendarDisplayMonth + direction;
            let newYear = appState.calendarDisplayYear;

            if (newMonth < 0) {
                newMonth = 11; newYear--;
            } else if (newMonth > 11) {
                newMonth = 0; newYear++;
            }
            appState.calendarDisplayMonth = newMonth;
            appState.calendarDisplayYear = newYear;
            renderCalendar(); 
        }

        // ================================================================
        // 4. FUNGSI UTAMA PEMBARUAN WAKTU & UI
        // ================================================================

        /**
         * Fungsi Induk untuk mengupdate state waktu, tampilan picker, dan peta/UI.
         */
        function updateTimeSelectionAndUI() {
            const idx = appState.selectedTimeIndex;
            console.log(`UI Update triggered for Index: ${idx}`);
            if (idx < 0) { 
                dateDisplay.textContent = "Memuat...";
                hourDisplay.textContent = "--:--";
                return;
            }

            // 1. Update tampilan teks di picker
            updateTimeSelectionDisplayOnly();

            // 2. Update state visual marker di peta
            updateMapFeaturesForTime(map);

            // 3. Update konten popup / sidebar jika terbuka
            updateDynamicUI();

            // 4. Update status tombol navigasi
            if (prevDayBtn) prevDayBtn.disabled = (idx < 24);
            if (nextDayBtn) nextDayBtn.disabled = (idx >= 312); 
            if (prevHourBtn) prevHourBtn.disabled = (idx <= 0);
            if (nextHourBtn) nextHourBtn.disabled = (idx >= 335);
        }

        /** Fungsi HANYA untuk update tampilan teks picker waktu (BERDASARKAN INDEKS) */
        function updateTimeSelectionDisplayOnly() {
            if (!dateDisplay || !hourDisplay) return;
            const idx = appState.selectedTimeIndex;
            if (idx < 0) { 
                 dateDisplay.textContent = "Memuat...";
                 hourDisplay.textContent = "--:--";
                 return;
            }

            const displayTimeZone = appState.activeTimezone || Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
            const currentTimestampUTC = getTimestampUTCFromIndex(idx); 

            if (currentTimestampUTC !== null) {
                const dateObj = new Date(currentTimestampUTC);
                dateDisplay.textContent = formatDateDisplayFromDate(dateObj, displayTimeZone);
                hourDisplay.textContent = formatHourDisplayFromDate(dateObj, displayTimeZone);
            } else {
                dateDisplay.textContent = "Error Waktu";
                hourDisplay.textContent = "--:--";
            }
        }


        /** * [PERBAIKAN] Mengupdate UI dinamis (Popup & Sidebar)
         * Sekarang juga menangani pembaruan popup klaster.
         */
        function updateDynamicUI() {
             // 1. Dapatkan data untuk lokasi/UI aktif
             const idx = appState.selectedTimeIndex;
             let activeData, timeZone, locationBaseTs;
             
             if (appState.activeLocationData?.hourly?.time) {
                 activeData = appState.activeLocationData;
                 timeZone = activeData.timezone;
                 locationBaseTs = activeData.baseTimestampUTC;
             }

             // 2. Update Popup (jika terbuka)
             if (popupManager.isOpen()) {
                const popupEl = popupManager.getElement();
                if (popupEl) {
                    const singlePopup = popupEl.querySelector('.weather-popup-content');
                    const clusterPopup = popupEl.querySelector('.cluster-popup-content');

                    if (singlePopup && activeData) { // --- Ini adalah POPUP MARKER TUNGGAL ---
                        try { 
                            const hourly = activeData.hourly;
                            if (idx < 0 || idx >= hourly.time.length) return;

                            const timestampUTC = getTimestampUTCFromIndex(idx, locationBaseTs);
                            const formattedTime = formatTimestamp(timestampUTC, timeZone);
                            const data = { is_day: hourly.is_day?.[idx], weather_code: hourly.weather_code?.[idx], suhu: hourly.temperature_2m?.[idx], terasa: hourly.apparent_temperature?.[idx], kelembapan: hourly.relative_humidity_2m?.[idx], prob_presipitasi: hourly.precipitation_probability?.[idx], kecepatan_angin_10m: hourly.wind_speed_10m?.[idx], arah_angin_10m: hourly.wind_direction_10m?.[idx] };
                            const { deskripsi, ikon } = getWeatherInfo(data.weather_code, data.is_day);

                            const timeEl = singlePopup.querySelector('#popup-time'); if(timeEl) timeEl.textContent = formattedTime; 
                            const iconEl=singlePopup.querySelector('#popup-icon'); if(iconEl) iconEl.className=ikon;
                            const tempEl=singlePopup.querySelector('#popup-temp'); if(tempEl) tempEl.textContent=`${data.suhu?.toFixed(1)??"-"}Â°C`;
                            const descEl=singlePopup.querySelector('#popup-desc'); if(descEl) descEl.textContent=`(${deskripsi})`;
                            const feelsLikeEl=singlePopup.querySelector('#popup-feelslike'); if(feelsLikeEl) feelsLikeEl.innerHTML=`Terasa: <b>${data.terasa?.toFixed(1)??"-"}Â°C</b>`;
                            const humidityEl=singlePopup.querySelector('#popup-humidity'); if(humidityEl) humidityEl.innerHTML=`Kelembapan: <b>${data.kelembapan??"-"}%</b>`;
                            const precipEl=singlePopup.querySelector('#popup-precipitation'); if(precipEl) precipEl.innerHTML=`Presipitasi: <b>${data.prob_presipitasi??"-"}%</b>`;
                            const windEl=singlePopup.querySelector('#popup-wind'); if(windEl) windEl.innerHTML=`Angin: <b>${data.kecepatan_angin_10m??"-"} m/s</b> dari arah ${data.arah_angin_10m??"-"}Â°`;
                        } catch (e) { console.warn("Error updating single popup DOM:", e); }
                    
                    } else if (clusterPopup) { // --- [PERBAIKAN] Ini adalah POPUP KLASTER ---
                        try {
                            const clusterItems = clusterPopup.querySelectorAll('.cluster-item');
                            clusterItems.forEach(item => {
                                const id = item.dataset.id;
                                if (!id) return;
                                
                                const itemData = clientWeatherCache.get(id); // Ambil data dari cache
                                if (!itemData || !itemData.hourly?.time || idx < 0 || idx >= itemData.hourly.time.length) {
                                    return; // Skip jika data invalid
                                }

                                // Ambil data baru untuk indeks saat ini
                                const itemHourly = itemData.hourly;
                                const displayData = { 
                                    suhu: itemHourly.temperature_2m[idx], 
                                    code: itemHourly.weather_code[idx], 
                                    is_day: itemHourly.is_day[idx] 
                                };
                                const { deskripsi: itemDeskripsi } = getWeatherInfo(displayData.code, displayData.is_day);

                                // Update elemen DOM di dalam item
                                const suhuEl = item.querySelector('.item-suhu');
                                const descEl = item.querySelector('.item-desc');
                                
                                if (suhuEl) suhuEl.textContent = `${displayData.suhu?.toFixed(1) ?? '-'}Â°C`;
                                if (descEl) descEl.textContent = itemDeskripsi;
                            });
                        } catch (e) { console.warn("Error updating cluster popup DOM:", e); }
                    }
                }
             }

             // 3. Update Sidebar (jika terbuka dan ada data aktif)
             if (appState.isSidebarOpen && sidebarEl && activeData) {
                 try { 
                    const hourly = activeData.hourly;
                    if (idx < 0 || idx >= hourly.time.length) return;

                    const timestampUTC = getTimestampUTCFromIndex(idx, locationBaseTs);
                    const formattedTime = formatTimestamp(timestampUTC, timeZone); // Hitung waktu untuk sidebar
                    const data = { is_day: hourly.is_day?.[idx], weather_code: hourly.weather_code?.[idx], suhu: hourly.temperature_2m?.[idx], terasa: hourly.apparent_temperature?.[idx], kelembapan: hourly.relative_humidity_2m?.[idx], prob_presipitasi: hourly.precipitation_probability?.[idx], kecepatan_angin_10m: hourly.wind_speed_10m?.[idx], arah_angin_10m: hourly.wind_direction_10m?.[idx] };
                    const { deskripsi, ikon } = getWeatherInfo(data.weather_code, data.is_day);

                    // [PERBAIKAN] Tambahkan update waktu sidebar
                    sidebarEl.querySelector('#sidebar-current-time').textContent = formattedTime;
                    sidebarEl.querySelector('#sidebar-current-icon').className = ikon;
                    sidebarEl.querySelector('#sidebar-current-temp').textContent = `${data.suhu?.toFixed(1) ?? '-'}Â°C`;
                    sidebarEl.querySelector('#sidebar-current-desc').textContent = deskripsi;
                    sidebarEl.querySelector('#sidebar-current-feelslike').textContent = `Terasa ${data.terasa?.toFixed(1) ?? '-'}Â°C`;
                    sidebarEl.querySelector('#sidebar-current-humidity').textContent = `Kelembapan: ${data.kelembapan ?? '-'}%`; 
                    sidebarEl.querySelector('#sidebar-current-precipitation').textContent = `Presipitasi: ${data.prob_presipitasi ?? '-'}%`; 
                    sidebarEl.querySelector('#sidebar-current-wind').textContent = `Angin: ${data.kecepatan_angin_10m ?? '-'} m/s dari arah ${data.arah_angin_10m ?? '-'}Â°`; 
                 } catch(e) { console.warn("Error updating sidebar DOM:", e); }
             }
        }


        /** Mengupdate state visual semua marker di peta berdasarkan waktu terpilih. */
        function updateMapFeaturesForTime(mapInstance) {
             if (!mapInstance || !mapInstance.getSource('data-cuaca-source')) return;
             const idx = appState.selectedTimeIndex; 
             if (idx < 0) return; 

             const sourceFeatures = mapInstance.querySourceFeatures('data-cuaca-source', { filter: ['!', ['has', 'point_count']] });
             const processedIds = new Set();
             for (const [id, data] of clientWeatherCache.entries()) {
                 processedIds.add(id);
                 let stateData = { hasData: false }; 
                 if (data?.hourly?.time && idx >= 0 && idx < data.hourly.time.length) {
                     const hourly = data.hourly;
                     const currentState = mapInstance.getFeatureState({ source: 'data-cuaca-source', id: id });
                     const isActive = currentState?.active || false;
                     stateData = { hasData: true, suhu: hourly.temperature_2m?.[idx] ?? -999, precip: hourly.precipitation_probability?.[idx] ?? -1, active: isActive };
                 }
                 mapInstance.setFeatureState({ source: 'data-cuaca-source', id: id }, stateData);
             }
             for (const feature of sourceFeatures) {
                  if (feature.id && !processedIds.has(feature.id)) { mapInstance.removeFeatureState({ source: 'data-cuaca-source', id: feature.id }); }
             }
        }

        /** Menghasilkan HTML untuk konten popup */
        function generatePopupContent(nama, data, deskripsi, ikon, formattedTime) {
            return `
                <div class="weather-popup-content">
                    <b>${nama}</b>
                    <div id="popup-time" style="font-size: 12px; color: #555;">${formattedTime}</div>
                    <div class="popup-current-weather">
                        <i id="popup-icon" class="${ikon}"></i>
                        <div class="popup-details">
                            <div><b id="popup-temp">${data.suhu?.toFixed(1) ?? '-'}Â°C</b> <span id="popup-desc">(${deskripsi})</span></div>
                            <div id="popup-feelslike">Terasa: <b>${data.terasa?.toFixed(1) ?? '-'}Â°C</b></div>
                            <div id="popup-humidity">Kelembapan: <b>${data.kelembapan ?? '-'}%</b></div>
                            <div id="popup-precipitation">Presipitasi: <b>${data.prob_presipitasi ?? '-'}%</b></div>
                            <div id="popup-wind">Angin: <b>${data.kecepatan_angin_10m ?? '-'} m/s</b> dari arah ${data.arah_angin_10m ?? '-'}Â°</div>
                        </div>
                    </div>
                    <div class="popup-actions"> <button onclick="openSidebarFromPopup()">Lihat Detail di Sidebar</button> </div>
                </div>`;
         }

        // ================================================================
        // 4. FUNGSI SIDEBAR & HIGHLIGHT (SAMA)
        // ================================================================
        function openSidebar() {
            if (!sidebarEl || !toggleBtnEl || appState.isSidebarOpen) return;
            removeActiveMarkerHighlight(); 
            sidebarEl.classList.add('sidebar-open');
            appState.isSidebarOpen = true;
            toggleBtnEl.innerHTML = '&lt;';
            toggleBtnEl.setAttribute('aria-label', 'Tutup detail lokasi');
            renderSidebarContent(); 
            setActiveMarkerHighlight(appState.activeLocationId); 
        }

        function closeSidebar() {
            if (!sidebarEl || !toggleBtnEl || !appState.isSidebarOpen) return;
            sidebarEl.classList.remove('sidebar-open');
            appState.isSidebarOpen = false;
            toggleBtnEl.innerHTML = '&gt;';
            toggleBtnEl.setAttribute('aria-label', 'Buka detail lokasi');
            if (appState.activeLocationId) { console.log("No active location ID to remove highlight from."); return }
            removeActiveMarkerHighlight(appState.activeLocationId); 
        }

        function toggleSidebar() { if (appState.isSidebarOpen) closeSidebar(); else openSidebar(); }

         function openSidebarFromPopup() {
             if (!appState.isSidebarOpen) { openSidebar(); }
             else { if (sidebarContentEl) sidebarContentEl.scrollTop = 0; }
             popupManager.close(true); 
         }

        function renderSidebarContent() {
            if (!appState.isSidebarOpen || !sidebarContentEl || !sidebarPlaceholderEl || !sidebarLoadingEl || !sidebarWeatherDetailsEl || !sidebarProvinceDetailsEl || !sidebarLocationNameEl) { return; }

            sidebarPlaceholderEl.style.display = 'none';
            sidebarLoadingEl.style.display = 'none';
            sidebarWeatherDetailsEl.style.display = 'none';
            sidebarProvinceDetailsEl.style.display = 'none';
            sidebarLocationNameEl.textContent = 'Detail Lokasi';

            if (appState.isClickLoading) { 
                sidebarLoadingEl.style.display = 'block';
                sidebarLocationNameEl.textContent = `Memuat ${appState.activeLocationName || 'lokasi'}...`;
            } else if (!appState.activeLocationId) { 
                sidebarPlaceholderEl.textContent = 'Pilih satu wilayah di peta.';
                sidebarPlaceholderEl.style.display = 'block';
            } else if (appState.activeLocationData?.type === 'provinsi') { 
                 sidebarProvinceDetailsEl.innerHTML = `<h3>${appState.activeLocationName}</h3><p>(Detail informasi provinsi)</p>`;
                 sidebarProvinceDetailsEl.style.display = 'block';
                 sidebarLocationNameEl.textContent = appState.activeLocationName;
            } else if (appState.activeLocationData?.hourly) { 
                sidebarWeatherDetailsEl.style.display = 'block';
                sidebarLocationNameEl.textContent = appState.activeLocationName;

                const daily = appState.activeLocationData.daily;
                const timeZone = appState.activeLocationData.timezone;
                const listContainer = sidebarEl.querySelector('#sidebar-daily-forecast-list');
                listContainer.innerHTML = '';
                if (daily?.time) {
                    for (let i = 0; i < daily.time.length; i++) {
                        const date = daily.time[i], code = daily.weather_code?.[i], maxT = daily.temperature_2m_max?.[i], minT = daily.temperature_2m_min?.[i];
                        if (date === undefined || code === undefined || maxT === undefined || minT === undefined) continue;
                        const { deskripsi, ikon } = getWeatherInfo(code, 1);
                        const itemHTML = `<div class="daily-forecast-item"><span class="daily-day">${formatDayOnly(date, timeZone)}</span><i class="daily-icon ${ikon}"></i><span class="daily-desc">${deskripsi}</span><span class="daily-temp">${maxT.toFixed(1)}Â° / ${minT.toFixed(1)}Â°</span></div>`;
                        listContainer.innerHTML += itemHTML;
                    }
                } else { listContainer.innerHTML = '<p><i>Data harian tidak tersedia.</i></p>'; }
                updateDynamicUI(); // Isi "Current Conditions"
            } else if (appState.activeLocationId) { 
                 sidebarPlaceholderEl.textContent = `Data untuk ${appState.activeLocationName} tidak lengkap.`;
                 sidebarPlaceholderEl.style.display = 'block';
            } else { 
                 sidebarPlaceholderEl.textContent = 'Terjadi kesalahan.';
                 sidebarPlaceholderEl.style.display = 'block';
            }
        }

        function setActiveMarkerHighlight(id) {
             if (!id || !map || !map.getSource('data-cuaca-source')) return;
             console.log("Highlighting:", id);
             try {
                const currentState = map.getFeatureState({ source: 'data-cuaca-source', id: id }) || {};
                if (!currentState.active) { map.setFeatureState( { source: 'data-cuaca-source', id: id }, { ...currentState, active: true }); }
             } catch (e) { console.error("Error setting active highlight:", e); }
        }

        function removeActiveMarkerHighlight(idToRemove = null) { 
            const targetId = idToRemove || appState.previousActiveLocationId;
            if (targetId && map && map.getSource('data-cuaca-source')) {
                console.log("Removing highlight from:", targetId);
                try {
                    const currentState = map.getFeatureState({ source: 'data-cuaca-source', id: targetId });
                    if (currentState?.active) {
                        map.setFeatureState( { source: 'data-cuaca-source', id: targetId }, { ...currentState, active: false });
                    }
                } catch (e) { console.error("Error removing highlight:", e); }
            }
             if (!idToRemove) {
                appState.previousActiveLocationId = null;
             }
        }

        // ================================================================
        // 5. LOGIKA INISIALISASI PETA & EVENT
        // ================================================================

        document.addEventListener('DOMContentLoaded', function() {

            // Ambil elemen UI
            sidebarEl = document.getElementById('detail-sidebar');
            toggleBtnEl = document.getElementById('sidebar-toggle-btn');
            closeBtnEl = document.getElementById('close-sidebar-btn');
            sidebarContentEl = document.getElementById('sidebar-content');
            sidebarLocationNameEl = document.getElementById('sidebar-location-name');
            sidebarPlaceholderEl = document.getElementById('sidebar-placeholder');
            sidebarLoadingEl = document.getElementById('sidebar-loading');
            sidebarWeatherDetailsEl = document.getElementById('sidebar-weather-details');
            sidebarProvinceDetailsEl = document.getElementById('sidebar-province-details');
            prevDayBtn = document.getElementById('prev-day-btn');
            nextDayBtn = document.getElementById('next-day-btn');
            dateDisplay = document.getElementById('date-display');
            calendarBtn = document.getElementById('calendar-btn');
            prevHourBtn = document.getElementById('prev-hour-btn');
            nextHourBtn = document.getElementById('next-hour-btn');
            hourDisplay = document.getElementById('hour-display');
            calendarPopup = document.getElementById('calendar-popup');
            calendarGrid = document.getElementById('calendar-grid');
            calendarMonthYear = document.getElementById('calendar-month-year');
            loadingSpinner = document.getElementById('global-loading-spinner');
            calendarPrevMonthBtn = document.getElementById('calendar-prev-month'); 
            calendarNextMonthBtn = document.getElementById('calendar-next-month'); 

            // Fetch WMO Codes
            fetch(`${baseUrl}/api/wmo-codes`)
                .then(res => res.ok ? res.json() : Promise.reject(`Error ${res.status}`))
                .then(data => { WMO_CODE_MAP = data; })
                .catch(e => console.error("Gagal memuat WMO codes:", e));

            // Inisialisasi Peta
            map = new maplibregl.Map({ 
                container: 'map',
                style: { 
                    version: 8,
                    glyphs: "https://protomaps.github.io/basemaps-assets/fonts/{fontstack}/{range}.pbf",
                    sources: { 
                        'cartodb-positron-nolabels': { type: 'raster', tiles: ['https://basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png'], tileSize: 256, attribution: '&copy; OpenStreetMap contributors &copy; CARTO' },
                        'batas-wilayah-vector': { type: 'vector', tiles: [`${baseUrl}/tiles/{z}/{x}/{y}.pbf`], minzoom: 4, maxzoom: 14, attribution: 'Data Batas Wilayah BIG' },
                        'data-cuaca-source': { type: 'geojson', data: { type: 'FeatureCollection', features: [] }, cluster: true, clusterMaxZoom: 13, clusterRadius: 80, promoteId: 'id' },
                        'provinsi-source': { type: 'geojson', data: { type: 'FeatureCollection', features: [] } }
                    },
                    layers: [ 
                        { id: 'cartodb-positron-layer', type: 'raster', source: 'cartodb-positron-nolabels' },
                        // Layer Batas Wilayah
                        { id: 'batas-provinsi-layer', type: 'line', source: 'batas-wilayah-vector', 'source-layer': 'batas_provinsi', minzoom: 5, maxzoom: 7.99, paint: { 'line-color': '#A0522D', 'line-width': 1.5, 'line-opacity': 0.7 }},
                        { id: 'batas-kabupaten-layer', type: 'line', source: 'batas-wilayah-vector', 'source-layer': 'batas_kabupatenkota', minzoom: 8, maxzoom: 10.99, paint: { 'line-color': '#4682B4', 'line-width': 1, 'line-opacity': 0.6 }},
                        { id: 'batas-kecamatan-layer', type: 'line', source: 'batas-wilayah-vector', 'source-layer': 'batas_kecamatandistrik', minzoom: 11, maxzoom: 14, paint: { 'line-color': '#556B2F', 'line-width': 0.8, 'line-opacity': 0.5 }},
                        // Layer Marker Provinsi
                        { id: 'provinsi-point-circle', type: 'circle', source: 'provinsi-source', paint: { 'circle-radius': 7, 'circle-color': 'rgba(255, 255, 255, 0.6)', 'circle-stroke-color': '#333', 'circle-stroke-width': 1 }},
                        { id: 'provinsi-point-label', type: 'symbol', source: 'provinsi-source', layout: { 'text-field': ['get', 'nama'], 'text-font': ['Noto Sans Regular'], 'text-size': 10, 'text-anchor': 'left', 'text-offset': [0.8, 0], 'text-optional': true }, paint: { 'text-color': '#333', 'text-halo-color': '#fff', 'text-halo-width': 1.2 }},
                        // Layer Klaster
                        { id: 'cluster-background-layer', type: 'circle', source: 'data-cuaca-source', filter: ['has', 'point_count'], paint: { 'circle-radius': ['step', ['get', 'point_count'], 18, 50, 22, 200, 26], 'circle-color': ['step', ['get', 'point_count'], '#51bbd6', 50, '#f1f075', 200, '#f28cb1'], 'circle-stroke-width': 1.5, 'circle-stroke-color': '#fff', 'circle-opacity': 0.9 }},
                        { id: 'cluster-count-layer', type: 'symbol', source: 'data-cuaca-source', filter: ['has', 'point_count'], layout: { 'text-field': '{point_count_abbreviated}', 'text-font': ['Noto Sans Regular'], 'text-size': 12 }, paint: {'text-color': '#333333', 'text-halo-color': '#ffffff', 'text-halo-width': 1.5, 'text-halo-blur': 1 } },
                        // Layer Marker Unclustered (dengan highlight)
                        {
                            id: 'unclustered-point-temp-circle', type: 'circle', source: 'data-cuaca-source', filter: ['!', ['has', 'point_count']],
                            paint: {
                                'circle-color': ['case', ['boolean', ['feature-state', 'hasData'], false], ['step', ['feature-state', 'suhu'], '#0d47a1', 15, '#1e88e5', 20, '#4caf50', 25, '#ffeb3b', 30, '#fb8c00', 35, '#e53935'], '#bdbdbd'],
                                'circle-radius': ['case', ['boolean', ['feature-state', 'active'], false], 8, 6],
                                'circle-stroke-width': ['case', ['boolean', ['feature-state', 'active'], false], 2.5, 1],
                                'circle-stroke-color': ['case', ['boolean', ['feature-state', 'active'], false], '#000000', '#ffffff'],
                                'circle-opacity': 0.95
                            }
                        },
                        {
                            id: 'unclustered-point-precip-ring', type: 'circle', source: 'data-cuaca-source', filter: ['!', ['has', 'point_count']],
                            paint: {
                                'circle-radius': ['case', ['boolean', ['feature-state', 'active'], false], 11, 9],
                                'circle-color': '#1e88e5',
                                'circle-opacity': ['case', ['any', ['==', ['feature-state', 'precip'], -1], ['!', ['boolean', ['feature-state', 'hasData'], false]]], 0.0, ['interpolate', ['linear'], ['feature-state', 'precip'], 10, 0.0, 50, 0.5, 100, 0.8]],
                                'circle-stroke-width': 1.5, 'circle-stroke-color': '#ffffff',
                                'circle-stroke-opacity': ['case', ['all', ['>', ['feature-state', 'precip'], 10], ['!=', ['feature-state', 'precip'], -1]], ['case', ['boolean', ['feature-state', 'active'], false], 1.0, 0.7], 0.0]
                            }
                        },
                        {
                            id: 'unclustered-point-label', type: 'symbol', source: 'data-cuaca-source', filter: ['!', ['has', 'point_count']],
                            layout: { 'text-field': ['get', 'nama'], 'text-font': ['Noto Sans Regular'], 'text-size': 9.5, 'text-anchor': 'top', 'text-offset': [0, 0.9], 'text-optional': true },
                            paint: { 'text-color': '#333', 'text-halo-color': '#fff', 'text-halo-width': 1 }
                        }
                    ]
                },
                center: [118.0149, -2.5489], zoom: 4.5, minZoom: 4, maxZoom: 14,
                maxBounds: [[90, -15], [145, 10]]
            });

            // --- Event Listener Global ---
            prevDayBtn.addEventListener('click', () => {
                const newIndex = Math.max(0, appState.selectedTimeIndex - 24); 
                if (newIndex !== appState.selectedTimeIndex) {
                    appState.selectedTimeIndex = newIndex;
                    updateTimeSelectionAndUI(); 
                }
            });
            nextDayBtn.addEventListener('click', () => {
                const newIndex = Math.min(335, appState.selectedTimeIndex + 24); 
                if (newIndex !== appState.selectedTimeIndex) {
                    appState.selectedTimeIndex = newIndex;
                    updateTimeSelectionAndUI();
                }
            });
            prevHourBtn.addEventListener('click', () => {
                const newIndex = Math.max(0, appState.selectedTimeIndex - 1); 
                if (newIndex !== appState.selectedTimeIndex) {
                    appState.selectedTimeIndex = newIndex;
                    updateTimeSelectionAndUI();
                }
            });
            nextHourBtn.addEventListener('click', () => {
                const newIndex = Math.min(335, appState.selectedTimeIndex + 1); 
                 if (newIndex !== appState.selectedTimeIndex) {
                    appState.selectedTimeIndex = newIndex;
                    updateTimeSelectionAndUI();
                }
            });
            calendarBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleCalendar(); });
            calendarPrevMonthBtn.addEventListener('click', (e) => { e.stopPropagation(); changeCalendarMonth(-1); });
            calendarNextMonthBtn.addEventListener('click', (e) => { e.stopPropagation(); changeCalendarMonth(1); });

            toggleBtnEl.addEventListener('click', toggleSidebar);
            closeBtnEl.addEventListener('click', closeSidebar);

            // --- Logika Peta on 'load' ---
            map.on('load', () => {
                map.addSource('cartodb-labels', { type: 'raster', tiles: ['https://basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png'], tileSize: 256 });
                map.addLayer({ id: 'cartodb-labels-layer', type: 'raster', source: 'cartodb-labels', minzoom: 7 });

                const cuacaSource = () => map.getSource('data-cuaca-source');
                const provinsiSource = () => map.getSource('provinsi-source');

                let dataController;
                async function perbaruiPetaGeo() {
                     if (dataController) dataController.abort();
                     dataController = new AbortController();
                     const signal = dataController.signal;
                     const zoom = map.getZoom();
                     if (zoom <= 7.99) { 
                         if (cuacaSource()) cuacaSource().setData({ type: 'FeatureCollection', features: [] });
                         try {
                              const resp = await fetch(`${baseUrl}/api/provinsi-info`, { signal });
                              if (!resp.ok) throw new Error(`HTTP error ${resp.status}`);
                              const provinsiData = await resp.json();
                              const features = provinsiData.map(p => ({ type: 'Feature', geometry: { type: 'Point', coordinates: [p.lon, p.lat] }, properties: { id: p.id, nama: p.nama, type: 'provinsi' } }));
                              if (provinsiSource()) provinsiSource().setData({ type: 'FeatureCollection', features: features });
                         } catch (e) { if (e.name !== 'AbortError') console.error('Gagal ambil data provinsi:', e); }
                     } else { 
                         if (provinsiSource()) provinsiSource().setData({ type: 'FeatureCollection', features: [] });
                         const bounds = map.getBounds();
                         const bbox = `${bounds.getWest()},${bounds.getSouth()},${bounds.getEast()},${bounds.getNorth()}`;
                         try {
                            const resp = await fetch(`${baseUrl}/api/data-cuaca?bbox=${bbox}&zoom=${zoom}`, { signal });
                            if (!resp.ok) throw new Error(`HTTP error ${resp.status}`);
                            const geoOnly = await resp.json();
                            if (!geoOnly || geoOnly.error) { console.error("API Error (geo only):", geoOnly); return; }
                            const features = geoOnly.map(g => ({ type: 'Feature', id: g.id, geometry: { type: 'Point', coordinates: [g.lon, g.lat] }, properties: { id: g.id, nama: g.nama || 'N/A', type: 'kabkec' } }));
                            if (cuacaSource()) cuacaSource().setData({ type: 'FeatureCollection', features: features });
                         } catch (e) { if (e.name !== 'AbortError') console.error('Gagal ambil geo only data:', e); }
                     }
                } 

                async function fetchDataForVisibleMarkers() {
                    const zoom = map.getZoom();
                    if (zoom <= 7.99 || appState.isLoading) return;
                    const visibleFeatures = map.queryRenderedFeatures({ layers: ['unclustered-point-temp-circle'] });
                    if (!visibleFeatures.length) return;
                    const idsToFetch = visibleFeatures.map(f => f.id).filter(id => id && !clientWeatherCache.has(id) && !inflightIds.has(id));
                    if (!idsToFetch.length) return;
                    idsToFetch.forEach(id => inflightIds.add(id));
                    appState.isLoading = true;
                    loadingSpinner.style.display = 'block';
                    
                    let isFirstLoad = (appState.baseTimestampUTC === null); 
                    
                    try {
                        const resp = await fetch(`${baseUrl}/api/data-by-ids?ids=${idsToFetch.join(',')}`);
                        if (!resp.ok) throw new Error(`Network error ${resp.status}`);
                        const dataMap = await resp.json();

                        for (const id in dataMap) {
                            const data = dataMap[id];
                            
                            const baseTs = calculateBaseTimestamp(data.hourly?.time?.[0], data.utc_offset_seconds);
                            if (baseTs === null) {
                                console.warn(`Could not calculate base TS for ${id}, skipping data.`);
                                continue; 
                            }
                            data.baseTimestampUTC = baseTs; 
                            clientWeatherCache.set(id, data); 

                            // --- INISIALISASI WAKTU SAAT DATA PERTAMA TIBA ---
                            if (isFirstLoad) {
                                appState.baseTimestampUTC = baseTs; 
                                console.log(`Global Base timestamp set from first load (${id}):`, new Date(baseTs).toISOString());
                                
                                const nowUTC = Date.now();
                                const initialIndex = findIndexForTimestamp(nowUTC); 
                                console.log("Initial index calculated:", initialIndex);
                                appState.selectedTimeIndex = (initialIndex !== -1) ? initialIndex : 0;
                                
                                // [PERBAIKAN v3] Set activeTimezone ke timezone marker, BUKAN browser
                                appState.activeTimezone = data.timezone; 
                                console.log(`Initial timezone set to first marker's: ${appState.activeTimezone}`);

                                updateTimeSelectionAndUI(); // Update UI penuh sekarang
                                isFirstLoad = false; 
                            }
                            // --- AKHIR INISIALISASI ---

                            const idx = appState.selectedTimeIndex; 
                            const isActive = (id === appState.activeLocationId);
                            
                            if (data.hourly?.time && data.hourly.time.length > idx && idx >= 0) {
                                map.setFeatureState( { source: 'data-cuaca-source', id: id }, { hasData: true, suhu: data.hourly.temperature_2m[idx] ?? -999, precip: data.hourly.precipitation_probability[idx] ?? -1, active: isActive } );
                                
                                if (isActive && !appState.activeLocationData && appState.isClickLoading) {
                                    appState.activeLocationData = data;
                                    appState.activeTimezone = data.timezone; 
                                    appState.baseTimestampUTC = data.baseTimestampUTC;
                                    if (appState.isSidebarOpen) renderSidebarContent();
                                    updateTimeSelectionAndUI(); 
                                }
                            } else { 
                                map.setFeatureState({ source: 'data-cuaca-source', id: id }, { hasData: false, active: isActive }); 
                            }
                        }
                    } catch (e) { console.error("Gagal BBOX fetch:", e); }
                    finally {
                        idsToFetch.forEach(id => inflightIds.delete(id));
                        appState.isLoading = false;
                        loadingSpinner.style.display = 'none';
                        
                        if (!isFirstLoad) {
                           updateMapFeaturesForTime(map); 
                        }
                    }
                } // Akhir fetchDataForVisibleMarkers

                // Pemicu Event Peta
                const perbaruiPetaDebounced = debounce(perbaruiPetaGeo, 700);
                map.on('moveend', perbaruiPetaDebounced);
                map.on('idle', fetchDataForVisibleMarkers);

                perbaruiPetaGeo(); // Muat GeoJSON awal

                // ================================================================
                // 6. LOGIKA KLIK PETA (Event Utama - Menggunakan popupManager)
                // ================================================================
                const allInteractiveLayers = [ 'cluster-background-layer', 'unclustered-point-temp-circle', 'provinsi-point-circle' ];
                map.on('click', (e) => {
                    const features = map.queryRenderedFeatures(e.point, { layers: allInteractiveLayers });

                    if (appState.isSidebarOpen && !features.length) { 
                        const sidebarClicked = e.originalEvent.target.closest('#detail-sidebar');
                        const popupClicked = e.originalEvent.target.closest('.maplibregl-popup');
                        const controlClicked = e.originalEvent.target.closest('.maplibregl-ctrl');
                        const toggleClicked = e.originalEvent.target.closest('#sidebar-toggle-btn');
                        const pickerClicked = e.originalEvent.target.closest('#datetime-picker-container');
                        const calendarClicked = e.originalEvent.target.closest('#calendar-popup');
                        if (!sidebarClicked && !popupClicked && !controlClicked && !toggleClicked && !pickerClicked && !calendarClicked) {
                            closeSidebar();
                        }
                    }

                    if (!features.length) { 
                        popupManager.close();
                        return;
                    }

                    const feature = features[0];
                    const layerId = feature.layer.id;
                    const props = feature.properties;
                    const coordinates = feature.geometry.coordinates.slice();

                    if (layerId === 'cluster-background-layer') { handleClusterClick(feature, coordinates); }
                    else if (layerId === 'provinsi-point-circle') { handleProvinceClick(props, coordinates); }
                    else if (layerId === 'unclustered-point-temp-circle') {
                        const dataUntukHandler = { id: feature.id, nama: props.nama, lat: coordinates[1], lon: coordinates[0] };
                        handleUnclusteredClick(dataUntukHandler);
                    }
                }); 

                // ================================================================
                // 7. LOGIKA DOUBLE CLICK PETA
                // ================================================================
                map.on('dblclick', allInteractiveLayers, (e) => {
                     if (!e.features || !e.features.length) return;
                     const feature = e.features[0];
                     const layerId = feature.layer.id;
                     const featureId = feature.id;
                     console.log("Double Click Detected on:", featureId, "Layer:", layerId);
                     if (layerId === 'unclustered-point-temp-circle') {
                         if (featureId && featureId === appState.activeLocationId) {
                             console.log("Double click on ACTIVE marker. Opening sidebar.");
                             e.preventDefault(); 
                             openSidebar();
                         } else { console.log("Double click on INACTIVE marker. Ignoring."); }
                     } else { console.log("Double click on non-marker layer. Ignoring."); }
                }); 

                // ================================================================
                // 8. FUNGSI HANDLER KLIK (Menggunakan popupManager)
                // ================================================================

                /** Menangani klik pada klaster */
                function handleClusterClick(feature, coordinates) {
                     console.log("Handling Cluster Click");
                     popupManager.close(true);
                     const clusterId = feature.properties.cluster_id;
                     const source = cuacaSource();
                     source.getClusterLeaves(clusterId, Infinity, 0, (err, leaves) => {
                         if (err) { console.error("Error getting cluster leaves:", err); return; }
                         const loadingPopupRef = popupManager.open(coordinates, 'Memuat data klaster...');
                         if (!loadingPopupRef) return;
                         const idsToFetch = leaves.map(leaf => leaf.id || leaf.properties.id).filter(Boolean);
                         if (!idsToFetch.length) { popupManager.setHTML("Tidak ada lokasi valid."); return; }
                         fetch(`${baseUrl}/api/data-by-ids?ids=${idsToFetch.join(',')}`)
                            .then(response => response.json())
                            .then(dataDetailCuaca => {
                                if (popupManager.getInstance() !== loadingPopupRef) { return; }
                                const popupContent = document.createElement('div');
                                popupContent.className = 'cluster-popup-content'; // Class penting untuk update
                                popupContent.id = `cluster-popup-${clusterId}`;
                                popupContent.innerHTML = `<b>${leaves.length} Lokasi:</b><hr>`;
                                let itemsAdded = 0;
                                for (const id in dataDetailCuaca) {
                                     const data = dataDetailCuaca[id];
                                     if (!clientWeatherCache.has(id)) {
                                         const baseTs = calculateBaseTimestamp(data.hourly?.time?.[0], data.utc_offset_seconds);
                                         if (baseTs === null) {
                                            console.warn(`Could not calculate base TS for ${id} in cluster, skipping.`);
                                            continue; 
                                         }
                                         data.baseTimestampUTC = baseTs; 
                                         clientWeatherCache.set(id, data);
                                         const idx = appState.selectedTimeIndex;
                                         map.setFeatureState( { source: 'data-cuaca-source', id: id }, { hasData: true, suhu: data.hourly?.temperature_2m[idx] ?? -999, precip: data.hourly?.precipitation_probability[idx] ?? -1, active: false } );
                                     }
                                     const idxDisplay = appState.selectedTimeIndex;
                                     if (!data.hourly?.time || data.hourly.time.length <= idxDisplay || idxDisplay < 0) continue;
                                     const displayData = { nama: data.nama, suhu: data.hourly.temperature_2m[idxDisplay], code: data.hourly.weather_code[idxDisplay], is_day: data.hourly.is_day[idxDisplay] };
                                     const { deskripsi } = getWeatherInfo(displayData.code, displayData.is_day);
                                     const item = document.createElement('div');
                                     item.className = 'cluster-item'; // Class penting untuk update
                                     item.dataset.id = id; // ID penting untuk update
                                     item.innerHTML = `<span class="item-nama">${displayData.nama}</span> (<span class="item-suhu">${displayData.suhu?.toFixed(1) ?? '-'}Â°C</span>, <span class="item-desc">${deskripsi}</span>)`;
                                     item.onclick = (event) => {
                                         event.stopPropagation();
                                         if (popupManager.getInstance() === loadingPopupRef) {
                                              popupManager.close(true); 
                                         } else {
                                              console.warn("Referensi popup klaster hilang saat item diklik?");
                                         }
                                         handleUnclusteredClick(data);
                                     };
                                     popupContent.appendChild(item);
                                     itemsAdded++;
                                }
                                if (itemsAdded > 0) popupManager.setDOMContent(popupContent);
                                else popupManager.setHTML("Gagal...");
                            })
                            .catch(error => {
                                 console.error('Error fetching/processing cluster data:', error);
                                 if (popupManager.getInstance() === loadingPopupRef) { popupManager.setHTML('Gagal memuat data klaster.'); }
                             });
                     });
                } // Akhir handleClusterClick

                /** Menangani klik pada marker provinsi */
                function handleProvinceClick(props, coordinates) {
                    console.log("Handling Province Click:", props.nama);
                    popupManager.close(true);
                    const previousId = appState.activeLocationId;
                    appState.activeLocationId = props.id;
                    appState.activeLocationName = props.nama;
                    appState.activeLocationData = { type: 'provinsi' };
                    appState.previousActiveLocationId = previousId;
                    if (previousId && clientWeatherCache.has(previousId)) { removeActiveMarkerHighlight(previousId); }
                    
                    // --- RESET WAKTU KE DEFAULT BROWSER ---
                    const browserOffsetMinutes = new Date().getTimezoneOffset();
                    const browserOffsetSeconds = browserOffsetMinutes * -60;
                    const now = new Date();
                    const sevenDaysAgoBrowser = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
                    const year = sevenDaysAgoBrowser.getFullYear();
                    const month = String(sevenDaysAgoBrowser.getMonth() + 1).padStart(2, '0');
                    const day = String(sevenDaysAgoBrowser.getDate()).padStart(2, '0');
                    const localTimeString = `${year}-${month}-${day}T00:00`;
                    const defaultBaseTS = calculateBaseTimestamp(localTimeString, browserOffsetSeconds);

                    if (defaultBaseTS) {
                        appState.activeTimezone = null; 
                        appState.baseTimestampUTC = defaultBaseTS; 
                    } else {
                        console.warn("Could not calculate default base TS for browser.");
                        appState.activeTimezone = null;
                    }
                    updateTimeSelectionAndUI(); 
                    // --- AKHIR RESET WAKTU ---
                    
                    if (appState.isSidebarOpen) renderSidebarContent();
                    const popupHTML = `<b>Provinsi:</b><br>${props.nama}<br><button onclick="map.easeTo({ center: [${coordinates[0]}, ${coordinates[1]}], zoom: 8 });">Zoom ke Provinsi</button>`;
                    popupManager.open(coordinates, popupHTML);
                } // Akhir handleProvinceClick

                /** Menangani klik pada marker unclustered. */
                async function handleUnclusteredClick(props) {
                    const { id, nama, lat, lon } = props;
                    const coordinates = [lon, lat];
                    if (!coordinates || isNaN(coordinates[0]) || isNaN(coordinates[1])) { return; }
                    console.log("Handling Unclustered Click:", nama, id);
                    
                    popupManager.close(true);
                    const previousId = appState.activeLocationId;
                    appState.activeLocationId = id;
                    appState.activeLocationName = nama;
                    appState.previousActiveLocationId = previousId;
                    if (previousId) { removeActiveMarkerHighlight(previousId); }
                    setActiveMarkerHighlight(id);

                    // --- Cek Inflight ---
                    if (inflightIds.has(id)) {
                        console.log(`Data for ${id} is inflight. Setting loading state.`);
                        appState.activeLocationData = null; appState.isClickLoading = true;
                        popupManager.open(coordinates, `<b>${nama}</b><br>Memuat data...`);
                        if (appState.isSidebarOpen) renderSidebarContent();
                        return;
                    }

                    if (clientWeatherCache.has(id)) { // Cache Hit
                        console.log(`Cache hit for ${id}.`);
                        const data = clientWeatherCache.get(id);

                        // --- LOGIKA PERPINDAHAN WAKTU ---
                        appState.activeLocationData = data;                    
                        appState.activeTimezone = data.timezone;               
                        appState.baseTimestampUTC = data.baseTimestampUTC; 
                        // Indeks (appState.selectedTimeIndex) tetap sama
                        // --- AKHIR LOGIKA ---

                        appState.isClickLoading = false;
                        if (appState.isSidebarOpen) renderSidebarContent();
                        
                        const idx = appState.selectedTimeIndex; 
                        if (!data.hourly?.time || idx < 0 || idx >= data.hourly.time.length) {
                            console.error("Invalid cached data for:", id);
                            popupManager.open(coordinates, `<b>${nama}</b><br>Data tidak valid.`);
                            return;
                        }
                        const hourly = data.hourly;
                        const popupData = { is_day: hourly.is_day?.[idx], weather_code: hourly.weather_code?.[idx], suhu: hourly.temperature_2m?.[idx], terasa: hourly.apparent_temperature?.[idx], kelembapan: hourly.relative_humidity_2m?.[idx], prob_presipitasi: hourly.precipitation_probability?.[idx], kecepatan_angin_10m: hourly.wind_speed_10m?.[idx], arah_angin_10m: hourly.wind_direction_10m?.[idx] };
                        const { deskripsi, ikon } = getWeatherInfo(popupData.weather_code, popupData.is_day);
                        
                        const timestampUTC = getTimestampUTCFromIndex(idx, data.baseTimestampUTC);
                        const formattedTime = formatTimestamp(timestampUTC, data.timezone);
                        
                        const popupHTML = generatePopupContent(nama, popupData, deskripsi, ikon, formattedTime);
                        popupManager.open(coordinates, popupHTML);
                        
                        updateTimeSelectionAndUI(); // Panggil UI penuh untuk sinkronisasi picker
                        return;
                    }

                    // Cache Miss
                    console.log(`Cache miss for ${id}. Fetching...`);
                    appState.activeLocationData = null; appState.isClickLoading = true; inflightIds.add(id);
                    const loadingPopupRef = popupManager.open(coordinates, `<b>${nama}</b><br>Memuat...`);
                    if (!loadingPopupRef) { inflightIds.delete(id); appState.isClickLoading = false; return; }
                    if (appState.isSidebarOpen) renderSidebarContent();

                    try {
                        const resp = await fetch(`${baseUrl}/api/data-by-ids?ids=${id}`);
                        if (!resp.ok) throw new Error(`Network error ${resp.status}`);
                        const dataMap = await resp.json();
                        if (!dataMap?.[id]) throw new Error("Data lokasi tidak ditemukan");
                        const data = dataMap[id];
                        
                        const baseTs = calculateBaseTimestamp(data.hourly?.time?.[0], data.utc_offset_seconds);
                        if (baseTs === null) throw new Error("Failed to calculate base timestamp for fetched data");
                        data.baseTimestampUTC = baseTs; 
                        
                        console.log(`Fetch success for ${id}.`);
                        clientWeatherCache.set(id, data); 
                        
                        if (appState.activeLocationId === id) { 
                            // --- LOGIKA PERPINDAHAN WAKTU ---
                            appState.activeLocationData = data;
                            appState.activeTimezone = data.timezone;
                            appState.baseTimestampUTC = data.baseTimestampUTC; 
                            // Indeks (appState.selectedTimeIndex) tetap sama
                            // --- AKHIR LOGIKA ---

                            appState.isClickLoading = false;
                            const idx = appState.selectedTimeIndex; 
                            if (data.hourly?.time && data.hourly.time.length > idx && idx >=0) { map.setFeatureState( { source: 'data-cuaca-source', id: id }, { hasData: true, suhu: data.hourly.temperature_2m[idx] ?? -999, precip: data.hourly.precipitation_probability[idx] ?? -1, active: true } ); }
                            else { map.setFeatureState({ source: 'data-cuaca-source', id: id }, { hasData: false, active: true }); }
                            
                            if (popupManager.getInstance() === loadingPopupRef) {
                                if (data.hourly?.time && idx >= 0 && idx < data.hourly.time.length) {
                                    const popupData = { 
                                        is_day: data.hourly.is_day?.[idx], weather_code: data.hourly.weather_code?.[idx], suhu: data.hourly.temperature_2m?.[idx], terasa: data.hourly.apparent_temperature?.[idx], kelembapan: data.hourly.relative_humidity_2m?.[idx], prob_presipitasi: data.hourly.precipitation_probability?.[idx], kecepatan_angin_10m: data.hourly.wind_speed_10m?.[idx], arah_angin_10m: data.hourly.wind_direction_10m?.[idx]
                                    };
                                    const { deskripsi, ikon } = getWeatherInfo(popupData.weather_code, popupData.is_day);
                                    
                                    const timestampUTC = getTimestampUTCFromIndex(idx, data.baseTimestampUTC);
                                    const formattedTime = formatTimestamp(timestampUTC, data.timezone);

                                    const popupHTML = generatePopupContent(nama, popupData, deskripsi, ikon, formattedTime);
                                    popupManager.setHTML(popupHTML); 
                                } else { popupManager.setHTML(`<b>${nama}</b><br>Data tidak lengkap.`); }
                            }
                            if(appState.isSidebarOpen) renderSidebarContent();
                            updateTimeSelectionAndUI(); 
                        } else { 
                            const idx = appState.selectedTimeIndex;
                            if (data.hourly?.time && data.hourly.time.length > idx && idx >= 0) { map.setFeatureState( { source: 'data-cuaca-source', id: id }, { hasData: true, suhu: data.hourly.temperature_2m[idx] ?? -999, precip: data.hourly.precipitation_probability[idx] ?? -1, active: false } ); }
                            else { map.setFeatureState({ source: 'data-cuaca-source', id: id }, { hasData: false, active: false }); }
                        }
                    } catch (e) { 
                        console.error(`Fetch failed for ${id}:`, e);
                        if (appState.activeLocationId === id) {
                            appState.isClickLoading = false; appState.activeLocationData = null;
                            if (popupManager.getInstance() === loadingPopupRef) { popupManager.setHTML(`<b>${nama}</b><br>Gagal: ${e.message}`); }
                            if (appState.isSidebarOpen) renderSidebarContent(); 
                        }
                    } finally { 
                        inflightIds.delete(id);
                    }
                } // Akhir handleUnclusteredClick


                // Hover pointer & Info koordinat
                map.on('mousemove', (e) => { 
                     const features = map.queryRenderedFeatures(e.point, { layers: allInteractiveLayers });
                     map.getCanvas().style.cursor = features.length ? 'pointer' : '';
                 });
                const infoKoordinat = document.getElementById('koordinat-info'); 
                infoKoordinat.innerHTML = 'Geser kursor di atas peta'; 
                map.on('mousemove', (e) => { 
                     infoKoordinat.innerHTML = `Latitude: ${e.lngLat.lat.toFixed(5)} | Longitude: ${e.lngLat.lng.toFixed(5)}`;
                 });
                map.on('mouseout', () => { 
                     infoKoordinat.innerHTML = 'Geser kursor di atas peta';
                 });

            }); // Akhir map.on('load')
        }); // Akhir DOMContentLoaded
    </script>
</body>
</html>