<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Cuaca Interaktif (v3 - BBOX Load)</title>
    
    <link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
    <script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>
    
    <link rel="stylesheet" href="static/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.10/css/weather-icons.min.css">
</head>
<body>
    <div id="map"></div>
    <div id="koordinat-info"></div>

    <div id="global-loading-spinner">Memuat data cuaca...</div>

    <div id="timeline-container">
        <input type="range" id="global-time-slider" min="0" max="335" value="168">
        <span id="slider-time-label">Memuat...</span>
    </div>

    <div id="detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-location-name">Detail Cuaca</h2>
                <span class="modal-close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <div id="modal-current-conditions">
                    <i id="modal-current-icon" class="wi wi-na"></i>
                    <div id="modal-current-temp">-°C</div>
                    <div id="modal-current-desc">...</div>
                    <div id="modal-current-feelslike">Terasa ...°C</div>
                </div>
                <h3 id="modal-daily-forecast-title">Prakiraan 14 Hari</h3>
                <div id="modal-daily-forecast-list">
                </div>
            </div>
        </div>
    </div>

    <script>
        const protocol = window.location.protocol;
        const hostname = window.location.hostname;
        const port = '5000';
        const baseUrl = `${protocol}//${hostname}:${port}`;

        // ================================================================
        // 1. STATE MANAGEMENT & VARIABEL GLOBAL (REVISI)
        // ================================================================

        const DEFAULT_TIME_INDEX = 168;

        const appState = {
            selectedTimeIndex: DEFAULT_TIME_INDEX,
            isLoading: false, // Untuk BBOX loading
            isClickLoading: false, // Untuk loading spesifik saat klik
            
            // --- PERUBAHAN: State untuk popup/modal ---
            activeLocationId: null,      
            activeLocationName: null,    
            activeLocationData: null, // Tetap ada untuk mengisi popup/modal
        };

        let WMO_CODE_MAP = {};
        let currentPopup = null;
        
        // --- PERUBAHAN: Cache Klien 14-Hari ---
        // Ini akan menyimpan data 14-hari penuh untuk SETIAP id yang dimuat
        const clientWeatherCache = new Map();
        
        // --- PERUBAHAN: Set untuk melacak request BBOX ---
        const inflightIds = new Set();


        // ================================================================
        // 2. FUNGSI HELPER
        // ================================================================

        function getWeatherInfo(weather_code, is_day) {
            const default_info = ["Data Tidak Tersedia", "wi-na"];
            const info = WMO_CODE_MAP[weather_code];
            if (!info) {
                return { deskripsi: default_info[0], ikon: `wi ${default_info[1]}` };
            }
            const deskripsi = info[0];
            const icon_class = (is_day == 1) ? info[1] : info[2];
            return { deskripsi: deskripsi, ikon: `wi ${icon_class}` };
        }
        
        // --- PERUBAHAN: Helper baru untuk ikon di PETA ---
        // Menggunakan emoji unicode sederhana agar render di MapLibre reliable
        function getWeatherEmoji(weather_code) {
            if (weather_code <= 1) return '☀️'; // Cerah
            if (weather_code === 2) return '⛅️'; // Berawan sebagian
            if (weather_code === 3) return '☁️'; // Mendung
            if (weather_code >= 45 && weather_code <= 48) return '🌫️'; // Kabut
            if (weather_code >= 51 && weather_code <= 69) return '🌧️'; // Hujan/Gerimis
            if (weather_code >= 80 && weather_code <= 82) return '🌧️'; // Hujan
            if (weather_code >= 71 && weather_code <= 79) return '❄️'; // Salju
            if (weather_code >= 95) return '⚡️'; // Badai
            return ''; // Kosong
        }

        function formatDateTime(isoString, timeZone) {
            if (!isoString || !timeZone) return "Invalid Date";
            try {
                const date = new Date(isoString);
                const options = {
                    weekday: 'long', day: 'numeric', month: 'long',
                    hour: '2-digit', minute: '2-digit', timeZone: timeZone, hour12: false
                };
                return new Intl.DateTimeFormat('id-ID', options).format(date);
            } catch (e) {
                console.error("Error formatting date:", e);
                return "Invalid Date";
            }
        }
        
        function formatDayOnly(dateString, timeZone) {
             try {
                const date = new Date(dateString + 'T00:00:00');
                const options = { weekday: 'long', day: 'numeric', month: 'short', timeZone: timeZone };
                return new Intl.DateTimeFormat('id-ID', options).format(date);
            } catch (e) {
                return dateString;
            }
        }

        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        };

        // ================================================================
        // 3. FUNGSI UTAMA PEMBARUAN UI (RENDER)
        // ================================================================

        /**
         * Fungsi RENDER untuk POPUP & MODAL.
         * Hanya dipanggil saat slider digeser JIKA popup/modal terbuka.
         */
        function updateUIPopupModal() {
            // Guard clause (tetap sama)
            if (!appState.activeLocationData || !appState.activeLocationData.hourly) {
                return;
            }

            // Ekstraksi data (tetap sama)
            const idx = appState.selectedTimeIndex;
            const hourly = appState.activeLocationData.hourly;
            const timeZone = appState.activeLocationData.timezone || 'UTC';
            const data = {
                time: hourly.time[idx], is_day: hourly.is_day[idx],
                weather_code: hourly.weather_code[idx], suhu: hourly.temperature_2m[idx],
                terasa: hourly.apparent_temperature[idx], kelembapan: hourly.relative_humidity_2m[idx],
                prob_presipitasi: hourly.precipitation_probability[idx],
                kecepatan_angin_10m: hourly.wind_speed_10m[idx],
                arah_angin_10m: hourly.wind_direction_10m[idx]
            };
            const { deskripsi, ikon } = getWeatherInfo(data.weather_code, data.is_day);
            const formattedTime = formatDateTime(data.time, timeZone);

            // 4. Update Popup (jika sedang terbuka) - Logika BARU
            if (currentPopup && currentPopup.isOpen()) {
                
                // --- PERBAIKAN UTAMA DI SINI ---
                // Dapatkan elemen DOM root dari popup yang AKTIF
                const popupEl = currentPopup.getElement(); 

                // Jika elemen tidak ditemukan (misal popup sedang transisi), hentikan.
                if (!popupEl) return; 

                try {
                    // Gunakan popupEl.querySelector() alih-alih document.getElementById()
                    // Ini JAUH lebih cepat dan dijamin menemukan elemen yang tepat.
                    popupEl.querySelector('#popup-time').textContent = formattedTime;
                    popupEl.querySelector('#popup-icon').className = ikon;
                    popupEl.querySelector('#popup-temp').textContent = `${data.suhu.toFixed(1)}°C`;
                    popupEl.querySelector('#popup-desc').textContent = `(${deskripsi})`;
                    popupEl.querySelector('#popup-feelslike').innerHTML = `Terasa: <b>${data.terasa.toFixed(1)}°C</b>`;
                    popupEl.querySelector('#popup-humidity').innerHTML = `Kelembapan: <b>${data.kelembapan}%</b>`;
                    popupEl.querySelector('#popup-precipitation').innerHTML = `Presipitasi: <b>${data.prob_presipitasi}%</b>`;
                    popupEl.querySelector('#popup-wind').innerHTML = `Angin: <b>${data.kecepatan_angin_10m} m/s</b> dari ${data.arah_angin_10m}°`;
                } catch (e) {
                    // Ini bisa terjadi jika popup ditutup saat update sedang berjalan
                    // Abaikan saja error ini
                }
            }

            // 5. Update Modal (jika sedang terbuka) - (Logika ini sudah benar)
            const modal = document.getElementById('detail-modal');
            if (modal.style.display === 'block') {
                document.getElementById('modal-current-icon').className = ikon;
                document.getElementById('modal-current-temp').textContent = `${data.suhu.toFixed(1)}°C`;
                document.getElementById('modal-current-desc').textContent = deskripsi;
                document.getElementById('modal-current-feelslike').textContent = `Terasa ${data.terasa.toFixed(1)}°C`;
            }
        }
        
        // --- PERUBAHAN: Fungsi RENDER baru untuk PETA ---
        /**
         * Fungsi RENDER untuk PETA.
         * Dipanggil SETIAP kali slider digeser.
         * Memperbarui state visual semua marker di peta.
         */
        function updateMapFeaturesForTime(map) {
            const idx = appState.selectedTimeIndex;
            
            // 1. Update Label Slider (dipindah ke sini)
            const sliderLabel = document.getElementById('slider-time-label');
            // Coba cari zona waktu dari lokasi aktif, jika tidak ada pakai UTC
            const timeZone = appState.activeLocationData?.timezone || 'UTC';
            // Coba cari waktu dari lokasi aktif, jika tidak ada, buat dummy
            const timeStr = appState.activeLocationData?.hourly.time[idx] || new Date().toISOString(); 
            
            // Update label slider jika data sudah ada
            if (appState.activeLocationData) {
                 sliderLabel.textContent = formatDateTime(timeStr, timeZone);
            } else if (!clientWeatherCache.size) {
                 sliderLabel.textContent = "Geser peta untuk memuat data";
            } else {
                 sliderLabel.textContent = "Pilih lokasi untuk detail";
            }
            
            // 2. Iterasi SEMUA data di cache dan update feature state-nya
            for (const [id, data] of clientWeatherCache.entries()) {
                if (!data.hourly || !data.hourly.time) continue;
                
                const hourly = data.hourly;
                
                // Ekstrak data pada indeks waktu yang baru
                const stateData = {
                    hasData: true,
                    suhu: hourly.temperature_2m[idx],
                    precip: hourly.precipitation_probability[idx],
                    weather_code: hourly.weather_code[idx],
                    is_day: hourly.is_day[idx],
                    // Ambil emoji untuk peta
                    weather_emoji: getWeatherEmoji(hourly.weather_code[idx])
                };
                
                // Set state fitur. Ini akan memicu layer paint/layout.
                map.setFeatureState(
                    { source: 'data-cuaca-source', id: id },
                    stateData
                );
            }
        }

        function generatePopupContent(nama, data, deskripsi, ikon, formattedTime) {
            // --- PERBAIKAN: Tambahkan ID ke elemen dinamis ---
            return `
                <div class="weather-popup-content">
                    <b>${nama}</b>
                    <div id="popup-time" style="font-size: 12px; color: #555;">${formattedTime}</div>
                    <div class="popup-current-weather">
                        <i id="popup-icon" class="${ikon}"></i>
                        <div class="popup-details">
                            <div>
                                <b id="popup-temp">${data.suhu.toFixed(1)}°C</b>
                                <span id="popup-desc">(${deskripsi})</span>
                            </div>
                            <div id="popup-feelslike">Terasa: <b>${data.terasa.toFixed(1)}°C</b></div>
                            <div id="popup-humidity">Kelembapan: <b>${data.kelembapan}%</b></div>
                            <div id="popup-precipitation">Presipitasi: <b>${data.prob_presipitasi}%</b></div>
                            <div id="popup-wind">Angin: <b>${data.kecepatan_angin_10m} m/s</b> dari ${data.arah_angin_10m}°</div>
                        </div>
                    </div>
                    <div class="popup-actions">
                        <button id="show-detail-btn">Tampilkan Detail Lengkap</button>
                    </div>
                </div>
            `;
        }
        
        function openDetailModal() {
            if (!appState.activeLocationData) return;
            const modal = document.getElementById('detail-modal');
            const daily = appState.activeLocationData.daily;
            const timeZone = appState.activeLocationData.timezone || 'UTC';
            document.getElementById('modal-location-name').textContent = appState.activeLocationName;
            const listContainer = document.getElementById('modal-daily-forecast-list');
            listContainer.innerHTML = ''; 
            for (let i = 0; i < daily.time.length; i++) {
                const date = daily.time[i], code = daily.weather_code[i];
                const maxTemp = daily.temperature_2m_max[i], minTemp = daily.temperature_2m_min[i];
                const { deskripsi, ikon } = getWeatherInfo(code, 1); // Asumsi siang hari
                const itemHTML = `
                    <div class="daily-forecast-item">
                        <span class="daily-day">${formatDayOnly(date, timeZone)}</span>
                        <i class="daily-icon ${ikon}"></i>
                        <span class="daily-desc">${deskripsi}</span>
                        <span class="daily-temp">${maxTemp.toFixed(1)}° / ${minTemp.toFixed(1)}°</span>
                    </div>`;
                listContainer.innerHTML += itemHTML;
            }
            modal.style.display = 'block';
            updateUIPopupModal(); // Panggil versi popup/modal
        }
        
        function closeDetailModal() {
            document.getElementById('detail-modal').style.display = 'none';
        }
        
        const closeCurrentPopup = () => {
            if (currentPopup) { currentPopup.remove(); currentPopup = null; }
        };


        // ================================================================
        // 4. LOGIKA INISIALISASI PETA
        // ================================================================

        document.addEventListener('DOMContentLoaded', function() {
            
            const slider = document.getElementById('global-time-slider');
            const modal = document.getElementById('detail-modal');
            const modalCloseBtn = document.querySelector('.modal-close-btn');
            const loadingSpinner = document.getElementById('global-loading-spinner');

            fetch(`${baseUrl}/api/wmo-codes`)
                .then(res => res.json())
                .then(data => { WMO_CODE_MAP = data; })
                .catch(e => console.error("Gagal memuat WMO codes:", e));

            const map = new maplibregl.Map({
                container: 'map',
                style: {
                    version: 8,
                    glyphs: "https://protomaps.github.io/basemaps-assets/fonts/{fontstack}/{range}.pbf",
                    sources: {
                        'cartodb-positron-nolabels': {
                            type: 'raster', tiles: ['https://basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png'], tileSize: 256,
                            attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
                        },
                        'batas-wilayah-vector': {
                            type: 'vector', tiles: [`${baseUrl}/tiles/{z}/{x}/{y}.pbf`], minzoom: 5, maxzoom: 14
                        },
                        'data-cuaca-source': {
                            type: 'geojson', data: { type: 'FeatureCollection', features: [] },
                            cluster: true, clusterMaxZoom: 13, clusterRadius: 80,
                            // --- PERUBAHAN: Promote ID agar setFeatureState berfungsi ---
                            promoteId: 'id' 
                        },
                        'provinsi-source': {
                            type: 'geojson', data: { type: 'FeatureCollection', features: [] }
                        }
                    },
                    layers: [
                        { id: 'cartodb-positron-layer', type: 'raster', source: 'cartodb-positron-nolabels' },
                        { id: 'batas-provinsi-layer', type: 'line', source: 'batas-wilayah-vector', 'source-layer': 'batas_provinsi', minzoom: 5, maxzoom: 7.99, paint: { 'line-color': '#8B4513', 'line-width': 1.5 }},
                        { id: 'batas-kabupaten-layer', type: 'line', source: 'batas-wilayah-vector', 'source-layer': 'batas_kabupatenkota', minzoom: 8, maxzoom: 10.99, paint: { 'line-color': '#003366', 'line-width': 1 }},
                        { id: 'batas-kecamatan-layer', type: 'line', source: 'batas-wilayah-vector', 'source-layer': 'batas_kecamatandistrik', minzoom: 11, maxzoom: 14, paint: { 'line-color': '#276600', 'line-width': 0.8 }},
                        { id: 'provinsi-point-circle', type: 'circle', source: 'provinsi-source',
                          paint: { 'circle-radius': 8, 'circle-color': 'rgba(255, 255, 255, 0.5)', 'circle-stroke-color': '#000000', 'circle-stroke-width': 1.5 }},
                        { id: 'provinsi-point-label', type: 'symbol', source: 'provinsi-source',
                          layout: { 'text-field': ['get', 'nama'], 'text-font': ['Noto Sans Regular'], 'text-size': 11, 'text-anchor': 'left', 'text-offset': [1, 0] },
                          paint: { 'text-color': '#333', 'text-halo-color': '#fff', 'text-halo-width': 1.5, 'text-halo-blur': 1 }},
                        { id: 'cluster-background-layer', type: 'circle', source: 'data-cuaca-source', filter: ['has', 'point_count'],
                          paint: { 'circle-radius': ['step', ['get', 'point_count'], 15, 10, 20, 30, 25],
                                   'circle-color': ['step', ['get', 'point_count'], '#51bbd6', 10, '#f1f075', 30, '#f28cb1'],
                                   'circle-stroke-width': 2, 'circle-stroke-color': '#ffffff' }},
                        { id: 'cluster-count-layer', type: 'symbol', source: 'data-cuaca-source', filter: ['has', 'point_count'],
                          layout: { 'text-field': '{point_count_abbreviated}', 'text-font': ['Noto Sans Regular'], 'text-size': 12 }},
                        
                        // --- PERUBAHAN: STACK LAYER MARKER DINAMIS BARU ---
                        // (Layer 'unclustered-point-layer' dan 'unclustered-point-label' lama diganti)

                        // LAYER 1: Lingkaran Suhu (di koordinat)
                        {
                            id: 'unclustered-point-temp-circle',
                            type: 'circle',
                            source: 'data-cuaca-source',
                            filter: ['!', ['has', 'point_count']],
                            paint: {
                                'circle-color': [
                                    'case',
                                    ['boolean', ['feature-state', 'hasData'], false],
                                    // Palet warna Biru -> Kuning -> Merah
                                    ['step', ['feature-state', 'suhu'],
                                        '#0000ff', 10, // < 10°C = Biru
                                        '#00ffff', 20, // 10-20°C = Cyan
                                        '#00ff00', 25, // 20-25°C = Hijau
                                        '#ffff00', 30, // 25-30°C = Kuning
                                        '#ff8000', 35, // 30-35°C = Oranye
                                        '#ff0000'  // > 35°C = Merah
                                    ],
                                    '#9e9e9e' // Default abu-abu
                                ],
                                'circle-radius': 6,
                                'circle-stroke-width': 1,
                                'circle-stroke-color': '#fff'
                            }
                        },

                        // LAYER 2: Cincin Presipitasi (mengelilingi lingkaran suhu)
                        {
                            id: 'unclustered-point-precip-ring',
                            type: 'circle',
                            source: 'data-cuaca-source',
                            filter: ['!', ['has', 'point_count']],
                            paint: {
                                'circle-radius': 9, // Sedikit lebih besar dari lingkaran suhu (6px)
                                'circle-color': '#007bff', // Warna biru hujan
                                'circle-opacity': [
                                    'case',
                                    ['boolean', ['feature-state', 'hasData'], false],
                                    // Opasitas berdasarkan % presipitasi
                                    ['interpolate', ['linear'], ['feature-state', 'precip'],
                                        10, 0.0,  // 10% = 0% opacity (tidak terlihat)
                                        50, 0.5,  // 50% = 50% opacity
                                        100, 0.8  // 100% = 80% opacity
                                    ],
                                    0.0 // Default tidak terlihat
                                ],
                                'circle-stroke-width': 2,
                                'circle-stroke-color': '#ffffff',
                                'circle-stroke-opacity': [ // Stroke hanya terlihat jika cincin terlihat
                                    'case',
                                    ['>', ['feature-state', 'precip'], 10],
                                    1.0,
                                    0.0
                                ]
                            }
                        },
                        
                        // LAYER 3: Label Nama (di bawah lingkaran)
                        {
                            id: 'unclustered-point-label',
                            type: 'symbol',
                            source: 'data-cuaca-source',
                            filter: ['!', ['has', 'point_count']],
                            layout: {
                                'text-field': ['get', 'nama'], // Ini dari properties, BUKAN state, jadi VALID
                                'text-font': ['Noto Sans Regular'],
                                'text-size': 10,
                                'text-anchor': 'top',
                                'text-offset': [0, 0.8] // Offset ke bawah
                            },
                            paint: {
                                'text-color': '#333',
                                'text-halo-color': '#fff',
                                'text-halo-width': 1
                            }
                        }
                    ]
                },
                center: [118.0149, -2.5489], zoom: 4.5, minZoom: 5, maxZoom: 14,
                maxBounds: [[94.7, -11.3], [141.3, 6.3]]
            });

            // --- Event Listener Global ---

            // 1. Listener untuk Slider
            slider.addEventListener('input', () => {
                appState.selectedTimeIndex = parseInt(slider.value, 10);
                // Panggil KEDUA fungsi render
                updateMapFeaturesForTime(map); // Update semua marker di peta
                updateUIPopupModal(); // Update popup/modal JIKA terbuka
            });

            // 2. Listener Modal (tidak berubah)
            modalCloseBtn.addEventListener('click', closeDetailModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeDetailModal();
            });
            document.addEventListener('click', (e) => {
                if (e.target.id === 'show-detail-btn') openDetailModal();
            });

            // --- Logika Peta on 'load' ---
            map.on('load', () => {
                map.addSource('cartodb-labels', { type: 'raster', tiles: ['https://basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png'], tileSize: 256 });
                map.addLayer({ id: 'cartodb-labels-layer', type: 'raster', source: 'cartodb-labels' });
                map.addControl(new maplibregl.NavigationControl(), 'bottom-right');

                const cuacaSource = () => map.getSource('data-cuaca-source');
                const provinsiSource = () => map.getSource('provinsi-source');

                // Fungsi ini (perbaruiPetaGeo) tidak berubah,
                // tetap hanya memuat GeoJSON (id, nama, lat, lon)
                let dataController;
                async function perbaruiPetaGeo() {
                    if (dataController) dataController.abort();
                    dataController = new AbortController();
                    const signal = dataController.signal;
                    const zoom = map.getZoom();

                    if (zoom <= 7.99) {
                        cuacaSource().setData({ type: 'FeatureCollection', features: [] });
                        fetch(`${baseUrl}/api/provinsi-info`, { signal })
                            .then(response => response.json())
                            .then(provinsiData => {
                                const features = provinsiData.map(p => ({
                                    type: 'Feature',
                                    geometry: { type: 'Point', coordinates: [p.lon, p.lat] },
                                    properties: { id: p.id, nama: p.nama }
                                }));
                                provinsiSource().setData({ type: 'FeatureCollection', features: features });
                            })
                            .catch(e => { if (e.name !== 'AbortError') console.error('Gagal ambil data provinsi:', e); });
                    } else {
                        provinsiSource().setData({ type: 'FeatureCollection', features: [] });
                        const bounds = map.getBounds();
                        const bbox = `${bounds.getWest()},${bounds.getSouth()},${bounds.getEast()},${bounds.getNorth()}`;

                        try {
                            const resp = await fetch(`${baseUrl}/api/data-cuaca?bbox=${bbox}&zoom=${zoom}`, { signal });
                            const geoOnly = await resp.json();
                            if (!geoOnly || geoOnly.error) {
                                console.error("API Error (geo only):", geoOnly); return;
                            }
                            
                            const features = geoOnly.map(g => ({
                                type: 'Feature',
                                id: g.id, // ID ini penting untuk promoteId
                                geometry: { type: 'Point', coordinates: [g.lon, g.lat] },
                                properties: { id: g.id, tipe: 'cuaca', nama: g.nama || 'N/A' }
                            }));
                            
                            cuacaSource().setData({ type: 'FeatureCollection', features: features });
                            
                            // --- PERUBAHAN ---
                            // Setelah geojson di-set, pemicu BBOX loading akan
                            // ditangani oleh listener 'idle' di bawah.

                        } catch (e) {
                            if (e.name !== 'AbortError') console.error('Gagal ambil geo only data:', e);
                        }
                    }
                }
                
                // --- PERUBAHAN: Fungsi BBOX Loading Baru ---
                /**
                 * Mengambil data cuaca untuk semua marker yang terlihat di BBOX
                 * yang datanya belum ada di cache.
                 */
                async function fetchDataForVisibleMarkers() {
                    const zoom = map.getZoom();
                    if (zoom <= 7.99 || appState.isLoading) return; // Jangan muat jika di zoom provinsi

                    // Ambil semua fitur yang di-render di layer unclustered
                    // (Gunakan layer lingkaran suhu sebagai referensi)
                    const visibleFeatures = map.queryRenderedFeatures({ 
                        layers: ['unclustered-point-temp-circle'] 
                    });
                    
                    if (!visibleFeatures.length) return;

                    const idsToFetch = [];
                    for (const feature of visibleFeatures) {
                        const id = feature.id; // feature.id (karena promoteId)
                        // Cek cache DAN cek inflight
                        if (id && !clientWeatherCache.has(id) && !inflightIds.has(id)) {
                            idsToFetch.push(id);
                        }
                    }

                    if (!idsToFetch.length) return;

                    // Tandai ID ini sedang dalam proses fetch
                    idsToFetch.forEach(id => inflightIds.add(id));
                    appState.isLoading = true;
                    loadingSpinner.style.display = 'block';

                    try {
                        const resp = await fetch(`${baseUrl}/api/data-by-ids?ids=${idsToFetch.join(',')}`);
                        if (!resp.ok) throw new Error('Network response was not ok');
                        const dataMap = await resp.json();

                        // Proses data yang kembali
                        for (const id in dataMap) {
                            const data = dataMap[id];
                            // 1. Simpan data 14-hari penuh ke cache
                            clientWeatherCache.set(id, data);
                            
                            // 2. Set feature state AWAL untuk marker ini
                            const idx = appState.selectedTimeIndex;
                            const hourly = data.hourly;
                            if (hourly && hourly.time) {
                                map.setFeatureState(
                                    { source: 'data-cuaca-source', id: id },
                                    {
                                        hasData: true,
                                        suhu: hourly.temperature_2m[idx],
                                        precip: hourly.precipitation_probability[idx],
                                        weather_code: hourly.weather_code[idx],
                                        is_day: hourly.is_day[idx],                                        
                                    }
                                );
                            }
                        }
                        
                        // Aktifkan slider jika ini pertama kalinya
                        if (slider.disabled) {
                            slider.disabled = false;
                            updateMapFeaturesForTime(map); // Update label slider
                        }

                    } catch (e) {
                        console.error("Gagal BBOX fetch data cuaca:", e);
                    } finally {
                        // Selesai, hapus dari inflight
                        idsToFetch.forEach(id => inflightIds.delete(id));
                        appState.isLoading = false;
                        loadingSpinner.style.display = 'none';
                    }
                } // Akhir fetchDataForVisibleMarkers

                // --- PERUBAHAN: Pemicu Event Peta ---
                const perbaruiPetaDebounced = debounce(perbaruiPetaGeo, 700);
                map.on('moveend', perbaruiPetaDebounced);
                
                // Pemicu BBOX loading dipasang di 'idle'
                // 'idle' akan terpicu setelah 'moveend' selesai DAN setelah 'setData' selesai.
                map.on('idle', () => {
                    fetchDataForVisibleMarkers();
                });
                
                // Muat data awal
                perbaruiPetaGeo();
                
                // Aktifkan slider & update labelnya
                slider.disabled = false;
                updateMapFeaturesForTime(map);


                // ================================================================
                // 5. LOGIKA KLIK PETA (REVISI)
                // ================================================================
                
                const allInteractiveLayers = [
                    'cluster-background-layer', 'cluster-count-layer',
                    'unclustered-point-temp-circle', // Klik di lingkaran suhu
                    'provinsi-point-circle'
                ];

                map.on('click', (e) => {
                    const features = map.queryRenderedFeatures(e.point, { layers: allInteractiveLayers });
                    if (!features.length) {
                        closeCurrentPopup();
                        closeDetailModal();
                        return;
                    }

                    const feature = features[0];
                    const layerId = feature.layer.id;
                    const props = feature.properties;
                    const coordinates = feature.geometry.coordinates;

                    // --- Klik Klaster --- (Revisi)
                    if (layerId === 'cluster-background-layer' || layerId === 'cluster-count-layer') {
                        console.log("Cluster clicked. Closing existing UI..."); // <-- LOG 1
                        closeCurrentPopup();
                        closeDetailModal();
                        
                        const clusterId = feature.properties.cluster_id; // feature.id untuk cluster
                        const source = cuacaSource();

                        console.log("Getting cluster leaves for ID:", clusterId); // <-- LOG 2
                        source.getClusterLeaves(clusterId, Infinity, 0, (err, leaves) => {
                            if (err) {
                                console.error("Error getting cluster leaves:", err); // <-- LOG ERROR 1
                                return;
                            }
                            
                            console.log("Got leaves:", leaves); // <-- LOG 3
                            const loadingPopupHTML = 'Memuat data klaster...';
                            
                            // BUAT Popup Loading & SIMPAN Referensinya
                            const loadingPopup = new maplibregl.Popup({ maxWidth: '260px' })
                                .setLngLat(coordinates)
                                .setHTML(loadingPopupHTML)
                                .addTo(map);
                            currentPopup = loadingPopup; // Simpan referensi global
                            console.log("Loading popup created and assigned to currentPopup:", currentPopup); // <-- LOG 4

                            const idsToFetch = leaves.map(leaf => leaf.id || leaf.properties.id).filter(Boolean); // Coba ambil ID dari properties juga
                             if (!idsToFetch.length) {
                                console.warn("No valid IDs found in cluster leaves."); // <-- LOG WARNING
                                if (currentPopup) currentPopup.setHTML("Tidak ada lokasi valid di klaster ini.");
                                return;
                            }

                            console.log("Fetching data for IDs:", idsToFetch); // <-- LOG 5
                            fetch(`${baseUrl}/api/data-by-ids?ids=${idsToFetch.join(',')}`)
                                .then(response => {
                                    if (!response.ok) throw new Error(`Network response error: ${response.status}`);
                                    return response.json();
                                })
                                .then(dataDetailCuaca => {
                                    console.log("Received cluster data:", dataDetailCuaca); // <-- LOG 6
                                    
                                    // PENTING: Periksa apakah popup loading MASIH ADA
                                    if (!currentPopup || currentPopup !== loadingPopup) {
                                        console.warn("currentPopup changed or removed before data arrived!"); // <-- LOG WARNING 2
                                        // Jika popup sudah hilang/berubah, jangan coba update
                                        // Mungkin pengguna klik tempat lain?
                                        return; 
                                    }

                                    const popupContent = document.createElement('div');
                                    popupContent.className = 'cluster-popup-content';
                                    popupContent.innerHTML = `<b>${leaves.length} Lokasi:</b><hr style="margin: 4px 0;">`;

                                    let itemsAdded = 0;
                                    for (const id in dataDetailCuaca) {
                                        const data = dataDetailCuaca[id]; 
                                        
                                        // ... (logika cache & setFeatureState tetap sama) ...
                                        if (!clientWeatherCache.has(id)) { /* ... */ }

                                        const idx = DEFAULT_TIME_INDEX;
                                        if (!data.hourly || !data.hourly.time || data.hourly.time.length <= idx) {
                                            console.warn(`Data hourly tidak lengkap untuk ID ${id}, skip item.`);
                                            continue; // Skip item jika data tidak lengkap
                                        }
                                        const currentData = { /* ... */ 
                                            nama: data.nama, lat: data.lat, lon: data.lon,
                                            code: data.hourly.weather_code[idx],
                                            is_day: data.hourly.is_day[idx],
                                            suhu: data.hourly.temperature_2m[idx]
                                        };
                                        const { deskripsi, ikon } = getWeatherInfo(currentData.code, currentData.is_day);

                                        const item = document.createElement('div');
                                        item.className = 'cluster-item';
                                        item.innerText = `${currentData.nama} (${currentData.suhu.toFixed(1)}°C, ${deskripsi})`;
                                        
                                        item.onclick = (event) => { // <-- Tambahkan 'event'
                                        event.stopPropagation(); // <-- HENTIKAN BUBBLING DI SINI!

                                        // PERBAIKAN V3: Logika manual yang lebih hati-hati
                                        const itemData = dataDetailCuaca[id]; // data 14-hari penuh
                                        const coordinates = [itemData.lon, itemData.lat];

                                        // 1. Tutup popup daftar klaster yang LAMA
                                        closeCurrentPopup();

                                        // 2. LANGSUNG set state global BARU
                                        appState.activeLocationId = id;
                                        appState.activeLocationName = itemData.nama;
                                        appState.activeLocationData = itemData; // Data 14-hari

                                        // 3. Ambil data cuaca untuk waktu slider saat ini
                                        const idx = appState.selectedTimeIndex;
                                        const hourly = itemData.hourly;
                                        // Pastikan data hourly ada sebelum diakses
                                        if (!hourly || !hourly.time || hourly.time.length <= idx) {
                                            console.error("Data hourly tidak valid atau indeks di luar batas untuk item klaster:", itemData);
                                            // Mungkin tampilkan pesan error singkat di popup sementara?
                                            currentPopup = new maplibregl.Popup({ maxWidth: '260px' })
                                                .setLngLat(coordinates)
                                                .setHTML(`<b>${itemData.nama}</b><br>Data cuaca tidak lengkap.`)
                                                .addTo(map);
                                            // Tambahkan listener close dasar
                                            const thisPopupInstance = currentPopup;
                                            currentPopup.on('close', () => {
                                                if (currentPopup === thisPopupInstance) {
                                                    currentPopup = null;
                                                }
                                            });
                                            return; // Hentikan eksekusi jika data tidak valid
                                        }
                                        const popupData = {
                                            time: hourly.time[idx], is_day: hourly.is_day[idx],
                                            weather_code: hourly.weather_code[idx], suhu: hourly.temperature_2m[idx],
                                            terasa: hourly.apparent_temperature[idx], kelembapan: hourly.relative_humidity_2m[idx],
                                            prob_presipitasi: hourly.precipitation_probability[idx],
                                            kecepatan_angin_10m: hourly.wind_speed_10m[idx],
                                            arah_angin_10m: hourly.wind_direction_10m[idx]
                                        };
                                        const { deskripsi, ikon } = getWeatherInfo(popupData.weather_code, popupData.is_day);
                                        const formattedTime = formatDateTime(popupData.time, itemData.timezone);

                                        // 4. Buat HTML popup detail
                                        const popupHTML = generatePopupContent(itemData.nama, popupData, deskripsi, ikon, formattedTime);

                                        // 5. Buat instance Popup BARU dan SIMPAN referensinya SEGERA
                                        currentPopup = new maplibregl.Popup({ maxWidth: '260px' })
                                            .setLngLat(coordinates)
                                            .setHTML(popupHTML)
                                            .addTo(map);

                                        // 6. Tambahkan listener penutup yang benar
                                        const currentItemId = id;
                                        const thisPopupInstance = currentPopup; // Simpan referensi popup ini
                                        currentPopup.on('close', () => {
                                            if (appState.activeLocationId === currentItemId) {
                                                appState.activeLocationData = null;
                                                appState.activeLocationId = null;
                                                appState.activeLocationName = null;
                                            }
                                            // Hanya null-kan jika popup yang ditutup = popup ini
                                            if (currentPopup === thisPopupInstance) {
                                                currentPopup = null;
                                            }
                                        });
                                    }; // Akhir item.onclick
                                        popupContent.appendChild(item);
                                        itemsAdded++;
                                    } // Akhir loop

                                    console.log(`Trying to set content. Items added: ${itemsAdded}. currentPopup valid?`, !!currentPopup); // <-- LOG 7
                                    if (currentPopup && currentPopup === loadingPopup) { // Pastikan masih popup yang sama
                                        if (itemsAdded > 0) {
                                            currentPopup.setDOMContent(popupContent);
                                            console.log("Popup content updated."); // <-- LOG 8
                                        } else {
                                            currentPopup.setHTML("Gagal memproses data lokasi di klaster.");
                                            console.warn("No items added to cluster popup content."); // <-- LOG WARNING 3
                                        }
                                    } else {
                                        console.warn("Popup reference lost or changed before setting final content."); // <-- LOG WARNING 4
                                    }
                                })
                                .catch(error => {
                                    console.error('Error fetching/processing cluster data:', error); // <-- LOG ERROR 2
                                    // Periksa apakah popup loading masih ada sebelum update error
                                    if (currentPopup && currentPopup === loadingPopup) {
                                         currentPopup.setHTML('Gagal memuat data klaster.');
                                    } else {
                                         console.warn("Popup reference lost before setting error message."); // <-- LOG WARNING 5
                                    }
                                });
                        });
                        return;
                    } // Akhir if cluster click
                    
                    // --- Klik Marker Provinsi --- (Tidak berubah)
                    if (layerId === 'provinsi-point-circle') {
                        closeCurrentPopup();
                        closeDetailModal();
                        const popupHTML = `<b>Provinsi:</b><br>${props.nama}<br>
                            <button onclick="map.easeTo({ center: [${coordinates[0]}, ${coordinates[1]}], zoom: 8 });" style="margin-top: 8px; cursor: pointer;">Zoom ke Provinsi</button>`;
                        currentPopup = new maplibregl.Popup()
                            .setLngLat(coordinates).setHTML(popupHTML).addTo(map);
                        return;
                    }

                    // --- Klik Marker Unclustered (Revisi) ---
                    if (layerId === 'unclustered-point-temp-circle') {
                        // Buat objek props yang konsisten
                        const dataUntukHandler = {
                            id: feature.id, // Ambil dari feature.id (karena promoteId)
                            nama: props.nama,
                            lat: coordinates[1],
                            lon: coordinates[0]
                        };
                        handleUnclusteredClick(dataUntukHandler);
                    }
                });

                /**
                 * PERUBAHAN: Fungsi ini sekarang mengecek cache terlebih dahulu
                 * sebelum memanggil API.
                 */
                async function handleUnclusteredClick(props) {
                    const { id, nama, lat, lon } = props;
                    const coordinates = [lon, lat]

                    if (!coordinates || isNaN(coordinates[0]) || isNaN(coordinates[1])) {
                        console.error("Koordinat tidak valid di handleUnclusteredClick:", props);
                        return;
                    }
                    
                    closeCurrentPopup();
                    closeDetailModal();
                    
                    if (appState.isClickLoading) return;

                    // --- LOGIKA CACHE ---
                    if (clientWeatherCache.has(id)) {
                        // Data SUDAH ADA di cache. Langsung gunakan.
                        const data = clientWeatherCache.get(id);
                        
                        // Set state global untuk popup/modal
                        appState.activeLocationId = id;
                        appState.activeLocationName = nama;
                        appState.activeLocationData = data;
                        
                        // Reset slider ke index saat ini
                        slider.value = appState.selectedTimeIndex;
                        
                        // Panggil render popup/modal
                        updateUIPopupModal(); 
                        
                        // Buat popup
                        const idx = appState.selectedTimeIndex;
                        const { deskripsi, ikon } = getWeatherInfo(
                            data.hourly.weather_code[idx], data.hourly.is_day[idx]
                        );
                        const formattedTime = formatDateTime(
                            data.hourly.time[idx], data.timezone
                        );
                        
                        // Ekstrak data untuk popup
                        const hourly = data.hourly;
                        const popupData = {
                            time: hourly.time[idx], is_day: hourly.is_day[idx],
                            weather_code: hourly.weather_code[idx], suhu: hourly.temperature_2m[idx],
                            terasa: hourly.apparent_temperature[idx], kelembapan: hourly.relative_humidity_2m[idx],
                            prob_presipitasi: hourly.precipitation_probability[idx],
                            kecepatan_angin_10m: hourly.wind_speed_10m[idx],
                            arah_angin_10m: hourly.wind_direction_10m[idx]
                        };

                        const popupHTML = generatePopupContent(nama, popupData, deskripsi, ikon, formattedTime);
                        currentPopup = new maplibregl.Popup({ maxWidth: '260px' })
                            .setLngLat(coordinates).setHTML(popupHTML).addTo(map);
                        // Gunakan ID lokal saat ini untuk perbandingan
                        // Gunakan ID lokal saat ini untuk perbandingan
                        const currentItemId = id; 
                        // Simpan referensi popup INI
                        const thisPopupInstance = currentPopup; 
                        currentPopup.on('close', () => { 
                            if (appState.activeLocationId === currentItemId) {
                                    appState.activeLocationData = null; 
                                    appState.activeLocationId = null;
                                    appState.activeLocationName = null;
                            }
                            // Hanya null-kan jika popup yang ditutup = popup ini
                            if (currentPopup === thisPopupInstance) {
                                currentPopup = null; 
                            }
                        });
                        
                        return;
                    }
                    
                    // --- DATA BELUM ADA DI CACHE: Alur Loading ---
                    
                    appState.isClickLoading = true;
                    appState.activeLocationId = id;
                    appState.activeLocationName = nama;
                    appState.activeLocationData = null;
                    
                    // Tampilkan popup "Memuat..."
                    currentPopup = new maplibregl.Popup({ maxWidth: '260px' })
                        .setLngLat(coordinates)
                        .setHTML(`<b>${nama}</b><br>Memuat data cuaca...`)
                        .addTo(map);

                    try {
                        // Panggil API
                        const resp = await fetch(`${baseUrl}/api/data-by-ids?ids=${id}`);
                        if (!resp.ok) throw new Error(`Network response was not ok (${resp.status})`);
                        const dataMap = await resp.json();
                        if (!dataMap || !dataMap[id]) throw new Error("Data lokasi tidak ditemukan");

                        const data = dataMap[id];

                        // 1. Simpan ke cache global
                        clientWeatherCache.set(id, data);
                        
                        // 2. Set state global untuk popup/modal
                        appState.activeLocationData = data;
                        appState.isClickLoading = false;

                        // 3. Set feature state AWAL (untuk 'sekarang')
                        const idx = DEFAULT_TIME_INDEX;
                        appState.selectedTimeIndex = idx;
                        slider.value = idx;
                        
                        map.setFeatureState(
                            { source: 'data-cuaca-source', id: id },
                            {
                                hasData: true,
                                suhu: data.hourly.temperature_2m[idx],
                                precip: data.hourly.precipitation_probability[idx],
                                weather_code: data.hourly.weather_code[idx],
                                is_day: data.hourly.is_day[idx],                            
                            }
                        );
                        
                        // 4. Update UI Peta & Popup
                        updateMapFeaturesForTime(map); // Update label slider
                        updateUIPopupModal(); // Update konten popup yang sedang terbuka

                    } catch (e) {
                        console.error("Gagal memuat data cuaca (klik):", e);
                        appState.isClickLoading = false;
                        appState.activeLocationId = null;
                        appState.activeLocationName = null;
                        
                        if (currentPopup) {
                            currentPopup.setHTML(`<b>${nama}</b><br>Gagal memuat data cuaca.<br>${e.message}`);
                        }
                    } finally {
                        // Pastikan popup bisa ditutup
                        if (currentPopup) {
                            // Gunakan ID lokal saat ini untuk perbandingan
                            const currentItemId = id; 
                            // Simpan referensi popup INI
                            const thisPopupInstance = currentPopup; 
                            currentPopup.on('close', () => { 
                            if (appState.activeLocationId === currentItemId) {
                                    appState.activeLocationData = null; 
                                    appState.activeLocationId = null;
                                    appState.activeLocationName = null;
                            }
                            // Hanya null-kan jika popup yang ditutup = popup ini
                            if (currentPopup === thisPopupInstance) {
                                currentPopup = null; 
                            }
                        });
                    }
                    }
                } // Akhir handleUnclusteredClick

                // Hover pointer
                map.on('mousemove', (e) => {
                    const features = map.queryRenderedFeatures(e.point, { layers: allInteractiveLayers });
                    map.getCanvas().style.cursor = features.length ? 'pointer' : '';
                });

                // Info koordinat
                const infoKoordinat = document.getElementById('koordinat-info');
                infoKoordinat.innerHTML = 'Geser kursor di atas peta';
                map.on('mousemove', (e) => { infoKoordinat.innerHTML = `Latitude: ${e.lngLat.lat.toFixed(5)} | Longitude: ${e.lngLat.lng.toFixed(5)}`; });
                map.on('mouseout', () => { infoKoordinat.innerHTML = 'Geser kursor di atas peta'; });
            });
        });
    </script>
</body>
</html>