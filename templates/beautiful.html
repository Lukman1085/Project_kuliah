<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aesthetic Clustering Map</title>
    
    <!-- MapLibre GL JS -->
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    
    <!-- Weather Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.12/css/weather-icons.min.css">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        /* --- BASE & LAYOUT --- */
        body { margin: 0; padding: 0; font-family: 'Manrope', sans-serif; overflow: hidden; background: #f0f4f8; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        /* --- MARKER STYLING (Dari Kode Sebelumnya) --- */
        .marker-container {
            display: flex; flex-direction: column; align-items: center;
            cursor: pointer; pointer-events: auto;
            /* Agar transisi muncul/hilang halus saat clustering */
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        /* Label Floating */
        .location-badge {
            background: #1a1a1a; color: #fff; padding: 4px 10px; border-radius: 6px;
            font-size: 11px; font-weight: 700; margin-bottom: 6px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); position: relative; white-space: nowrap;
        }
        .location-badge::after {
            content: ''; position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%);
            border-width: 4px 4px 0; border-style: solid; border-color: #1a1a1a transparent transparent transparent;
        }

        /* Kapsul Utama */
        .marker-capsule {
            background: #fff; border-radius: 50px; padding: 4px 8px 4px 4px;
            display: flex; align-items: center; gap: 8px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15), 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .marker-capsule:hover { transform: scale(1.1); z-index: 99; }

        /* Ikon Utama */
        .main-icon-wrapper {
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 18px; color: #fff;
        }

        /* Composite Thermo */
        .thermo-stack { position: relative; width: 16px; height: 16px; margin-right: 4px; }
        .thermo-stack i { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px; line-height: 1; }
        .thermo-frame { color: #333; z-index: 2; }
        .thermo-liquid { z-index: 1; transition: color 0.3s; }

        /* Theme Colors */
        .sunny .main-icon-wrapper { background: linear-gradient(135deg, #FFC107, #FF9800); }
        .cloudy .main-icon-wrapper { background: linear-gradient(135deg, #90A4AE, #546E7A); }
        .rain .main-icon-wrapper { background: linear-gradient(135deg, #42A5F5, #1E88E5); }
        .storm .main-icon-wrapper { background: linear-gradient(135deg, #546E7A, #263238); }

        /* Anchor Point */
        .marker-anchor { width: 6px; height: 6px; background: #fff; border-radius: 50%; margin-top: -3px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: -1; }


        /* --- POPUP STYLING (GLASSMORPHISM) --- */
        .maplibregl-popup { z-index: 100; }
        .maplibregl-popup-content {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 16px;
            padding: 0;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            border: 1px solid rgba(255,255,255,0.5);
            overflow: hidden;
            min-width: 220px;
        }
        .maplibregl-popup-close-button { color: #666; font-size: 20px; padding: 8px; border-radius: 0 16px 0 10px; z-index: 2; }
        .maplibregl-popup-close-button:hover { background: #eee; }
        .maplibregl-popup-tip { border-top-color: rgba(255,255,255,0.9) !important; }

        /* Popup Header */
        .popup-header {
            background: #f8f9fa; padding: 12px 16px; border-bottom: 1px solid #eee;
            font-weight: 800; font-size: 13px; color: #333; text-transform: uppercase; letter-spacing: 0.5px;
        }
        
        /* Popup List */
        .popup-list { max-height: 200px; overflow-y: auto; padding: 8px; }
        .popup-list-item {
            display: flex; align-items: center; gap: 10px;
            padding: 8px; border-radius: 8px; transition: background 0.2s; cursor: default;
        }
        .popup-list-item:hover { background: #f0f0f0; }
        .list-icon { width: 24px; height: 24px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #555; }
        .list-name { font-size: 13px; font-weight: 600; color: #444; }
        .list-temp { font-size: 11px; color: #888; margin-left: auto; }

        /* Scrollbar halus */
        .popup-list::-webkit-scrollbar { width: 4px; }
        .popup-list::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

        /* Legend/Info kecil */
        .info-legend {
            position: absolute; bottom: 30px; left: 20px; 
            background: rgba(255,255,255,0.9); padding: 12px; border-radius: 12px;
            font-size: 12px; color: #555; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

    <div id="map"></div>
    
    <div class="info-legend">
        <b>Tips:</b> Klik Klaster berwarna untuk melihat daftar lokasi.
    </div>

    <script>
        // --- 1. DATA GENERATION ---
        // Membuat data dummy di sekitar Jakarta
        const center = [106.8456, -6.2088];
        const features = [];
        const count = 50; // Jumlah marker

        const locationNames = ["Menteng", "Kuningan", "Sudirman", "Senayan", "Monas", "Kemang", "Tebet", "Pluit", "Ancol", "Grogol", "Slipi", "Cawang", "Halim", "Cilandak", "Pondok Indah"];
        const weathers = ['sunny', 'cloudy', 'rain', 'storm'];

        for (let i = 0; i < count; i++) {
            const lng = center[0] + (Math.random() - 0.5) * 0.15;
            const lat = center[1] + (Math.random() - 0.5) * 0.15;
            const type = weathers[Math.floor(Math.random() * weathers.length)];
            const temp = 20 + Math.floor(Math.random() * 15); // 20-35
            const name = `${locationNames[Math.floor(Math.random() * locationNames.length)]} ${i+1}`;

            features.push({
                type: 'Feature',
                geometry: { type: 'Point', coordinates: [lng, lat] },
                properties: {
                    id: i,
                    name: name,
                    weather: type,
                    temp: temp
                }
            });
        }

        const geojson = { type: 'FeatureCollection', features: features };


        // --- 2. MAP INIT ---
        const map = new maplibregl.Map({
            container: 'map',
            style: 'https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json',
            center: center,
            zoom: 12,
            pitch: 0
        });

        // State untuk melacak marker HTML yang sedang aktif di layar
        // Kunci: Feature ID, Nilai: Marker Object
        const markersOnScreen = {};

        map.on('load', () => {
            
            // Tambahkan Source dengan Clustering Aktif
            map.addSource('weather-points', {
                type: 'geojson',
                data: geojson,
                cluster: true,
                clusterMaxZoom: 14, // Di atas zoom ini, klaster pecah jadi point
                clusterRadius: 50   // Radius pixel untuk menggabungkan point
            });

            // --- LAYER 1: CLUSTERS (Lingkaran Warna) ---
            map.addLayer({
                id: 'clusters',
                type: 'circle',
                source: 'weather-points',
                filter: ['has', 'point_count'],
                paint: {
                    // Warna dinamis berdasarkan jumlah point (Blue -> Yellow -> Pink)
                    'circle-color': [
                        'step', ['get', 'point_count'],
                        '#81D4FA', // < 5 (Biru Muda Pastel)
                        5, '#FFF59D', // < 10 (Kuning Pastel)
                        10, '#FFAB91' // > 10 (Merah Muda Pastel)
                    ],
                    'circle-radius': [
                        'step', ['get', 'point_count'],
                        20, // Radius kecil
                        5, 25, // Radius sedang
                        10, 30 // Radius besar
                    ],
                    // Efek Glowing Ring: Stroke transparan yang tebal
                    'circle-stroke-width': 8,
                    'circle-stroke-color': [
                        'step', ['get', 'point_count'],
                        'rgba(129, 212, 250, 0.4)',
                        5, 'rgba(255, 245, 157, 0.4)',
                        10, 'rgba(255, 171, 145, 0.4)'
                    ]
                }
            });

            // --- LAYER 2: CLUSTER COUNT (Angka) ---
            map.addLayer({
                id: 'cluster-count',
                type: 'symbol',
                source: 'weather-points',
                filter: ['has', 'point_count'],
                layout: {
                    'text-field': '{point_count_abbreviated}',
                    'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
                    'text-size': 14
                },
                paint: {
                    'text-color': '#444' // Warna teks gelap agar kontras
                }
            });

            // --- LAYER 3: UNCLUSTERED POINTS (Invisible Hitbox) ---
            // Ini triknya: Kita buat layer GL transparan untuk titik tunggal.
            // Layer ini TIDAK terlihat, tapi kita butuhkan untuk event 'render'
            // agar kita tahu di mana harus menaruh marker HTML kita.
            map.addLayer({
                id: 'unclustered-point-hitbox',
                type: 'circle',
                source: 'weather-points',
                filter: ['!', ['has', 'point_count']],
                paint: {
                    'circle-radius': 5,
                    'circle-color': 'transparent', // Invisible
                    'circle-opacity': 0
                }
            });


            // --- LOGIC 1: RENDER HTML MARKERS ---
            // Setiap kali peta bergerak (move, zoom, render), kita cek
            // titik mana yang "unclustered" yang terlihat di layar.
            map.on('render', () => {
                if (!map.getLayer('unclustered-point-hitbox')) return;

                // 1. Ambil semua fitur titik tunggal yang sedang terlihat di viewport
                const features = map.queryRenderedFeatures({ layers: ['unclustered-point-hitbox'] });
                
                // Set sederhana untuk melacak ID yang terlihat frame ini
                const visibleIDs = new Set();

                features.forEach(f => {
                    const props = f.properties;
                    const id = props.id; // ID Unik
                    visibleIDs.add(id);

                    // Jika marker belum ada di DOM, buat baru!
                    if (!markersOnScreen[id]) {
                        const el = createCustomMarkerElement(props);
                        
                        // Buat Marker MapLibre dan simpan di objek
                        const marker = new maplibregl.Marker({
                            element: el,
                            anchor: 'bottom', // Kaki marker di koordinat
                            offset: [0, -10]  // Sedikit naik agar pas
                        })
                        .setLngLat(f.geometry.coordinates)
                        .addTo(map);

                        markersOnScreen[id] = marker;
                    }
                });

                // 2. Bersihkan marker yang sudah tidak terlihat (atau sudah masuk klaster)
                for (const id in markersOnScreen) {
                    if (!visibleIDs.has(parseInt(id))) {
                        markersOnScreen[id].remove(); // Hapus dari peta
                        delete markersOnScreen[id];   // Hapus dari memori
                    }
                }
            });


            // --- LOGIC 2: KLIK PADA KLASTER (Show List Popup) ---
            map.on('click', 'clusters', async (e) => {
                const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
                const clusterId = features[0].properties.cluster_id;
                
                // Ambil 'leaves' (titik-titik di dalam klaster ini)
                const source = map.getSource('weather-points');
                
                source.getClusterLeaves(clusterId, 100, 0, (err, points) => {
                    if (err) return;

                    // Buat HTML untuk List Popup
                    let listHtml = '';
                    points.forEach(p => {
                        const props = p.properties;
                        // Mapping icon sederhana
                        const iconClass = 
                            props.weather === 'sunny' ? 'wi-day-sunny' :
                            props.weather === 'cloudy' ? 'wi-cloudy' :
                            props.weather === 'rain' ? 'wi-rain' : 'wi-thunderstorm';
                        
                        const iconColor = 
                            props.weather === 'sunny' ? '#FFC107' :
                            props.weather === 'cloudy' ? '#90A4AE' :
                            props.weather === 'rain' ? '#42A5F5' : '#37474F';

                        listHtml += `
                            <div class="popup-list-item">
                                <div class="list-icon" style="color: ${iconColor}">
                                    <i class="wi ${iconClass}"></i>
                                </div>
                                <div class="list-name">${props.name}</div>
                                <div class="list-temp">${props.temp}°C</div>
                            </div>
                        `;
                    });

                    const popupContent = `
                        <div class="popup-header">Area Overview (${points.length} Lokasi)</div>
                        <div class="popup-list">
                            ${listHtml}
                        </div>
                    `;

                    // Tampilkan Popup
                    new maplibregl.Popup({ 
                        closeButton: true, 
                        closeOnClick: true,
                        className: 'aesthetic-popup',
                        anchor: 'center', // Center relative to point
                        offset: 0 
                    })
                    .setLngLat(e.lngLat)
                    .setHTML(popupContent)
                    .addTo(map);
                });
            });

            // Ubah kursor jadi pointer saat hover klaster
            map.on('mouseenter', 'clusters', () => { map.getCanvas().style.cursor = 'pointer'; });
            map.on('mouseleave', 'clusters', () => { map.getCanvas().style.cursor = ''; });
        });

        // --- HELPER: Membuat HTML Element Marker (Sama seperti sebelumnya) ---
        function createCustomMarkerElement(props) {
            const type = props.weather;
            const temp = props.temp;

            const iconMap = {
                'sunny': 'wi-day-sunny',
                'cloudy': 'wi-cloudy',
                'rain': 'wi-rain',
                'storm': 'wi-thunderstorm'
            };

            // Warna cairan termometer sederhana
            let thermoColor = '#43A047';
            if(temp < 25) thermoColor = '#039BE5';
            else if(temp > 30) thermoColor = '#E53935';
            else thermoColor = '#FB8C00';

            const div = document.createElement('div');
            div.className = 'marker-container';
            
            // KITA GUNAKAN String Literal untuk performa create
            div.innerHTML = `
                <div class="location-badge">${props.name}</div>
                <div class="marker-capsule ${type}">
                    <div class="main-icon-wrapper">
                        <i class="wi ${iconMap[type]}"></i>
                    </div>
                    <div class="thermo-stack">
                        <i class="wi wi-thermometer-internal thermo-liquid" style="color: ${thermoColor}"></i>
                        <i class="wi wi-thermometer-exterior thermo-frame"></i>
                    </div>
                    <span style="font-size:12px; font-weight:600; color:#555;">${temp}°</span>
                </div>
                <div class="marker-anchor"></div>
            `;
            
            // Event Listener Klik Marker Individual (Opsional: Zoom ke titik)
            div.addEventListener('click', (e) => {
                e.stopPropagation(); // Cegah klik tembus ke peta
                map.flyTo({ center: [0,0], zoom: 16, essential: true }); // Placeholder
                // Atau tampilkan popup detail single marker disini
                new maplibregl.Popup({ offset: 40, anchor: 'top' })
                    .setLngLat([0,0]) // Set dinamis nanti
                    .setHTML(`<b>${props.name}</b><br>Detail cuaca lengkap...`)
                    .addTo(map);
            });

            return div;
        }

        // Navigasi Control
        map.addControl(new maplibregl.NavigationControl({showCompass: false}), 'bottom-right');

    </script>
</body>
</html>